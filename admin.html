<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - PCCM Faculty Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f7f8fc; }
    .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header h1 { font-size: 32px; font-weight: 700; color: #1f2937; }
    .header p { color: #6b7280; margin-top: 4px; }
    .btn-primary { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .btn-danger { padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-secondary { padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 13px; }
    .btn-success { padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 13px; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #6b7280; transition: all 0.2s; font-size: 14px; }
    .tab-btn:hover { color: #1f2937; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
    .card-title { font-size: 20px; font-weight: 700; color: #1f2937; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .form-group small { display: block; margin-top: 4px; color: #6b7280; font-size: 12px; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .alert.show { display: block; }
    .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    table { width: 100%; border-collapse: collapse; font-size: 18px; }
    th { background: #f9fafb; padding: 12px 8px; text-align: left; font-weight: 600; color: #6b7280; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
    td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-admin { background: #dbeafe; color: #1e40af; }
    .badge-moonlighter { background: #fef3c7; color: #92400e; }
    .badge-active { background: #d1fae5; color: #065f46; }
    .badge-inactive { background: #fee2e2; color: #991b1b; }
    .editable-cell { cursor: pointer; position: relative; }
    .editable-cell:hover { background: #f3f4f6; }
    .editable-cell input { padding: 4px 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 13px; }
    .loading { text-align: center; padding: 40px; color: #6b7280; }
    .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .error-message { color: #dc2626; background: #fee2e2; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #dc2626; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
    .modal-title { font-size: 20px; font-weight: 700; }
    .close-btn { cursor: pointer; font-size: 24px; color: #6b7280; }
    .close-btn:hover { color: #1f2937; }
    .table-scroll { overflow-x: auto; }
    .weeks-cell { font-size: 12px; }
    .weeks-expected { color: #6b7280; font-weight: 600; }
    .weeks-actual { color: #1f2937; font-weight: 700; }
    .weeks-mismatch { color: #dc2626; font-weight: 700; }

    /* Schedule viewer styles */
    .schedule-modal-content { max-width: 95%; width: 1400px; }
    .schedule-grid { overflow-x: auto; }
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .schedule-table th { background: #f9fafb; padding: 10px 8px; text-align: left; font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; border: 1px solid #e5e7eb; white-space: nowrap; }
    .schedule-table td { padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; }
    .schedule-table tr:hover { background: #f9fafb; }
    .schedule-week-complete { background: #d1fae5; }
    .schedule-week-incomplete { background: #fee2e2; }
    .assignment-badge { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #dbeafe; color: #1e40af; }
    .assignment-slot-empty { color: #dc2626; font-style: italic; font-size: 11px; }
    
    /* Heatmap styles */
    .year-selector button.active { background: #667eea !important; color: white !important; border-color: #667eea !important; }
    .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
    .week-cell { padding: 12px; border-radius: 8px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s; }
    .week-cell:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .week-num { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; }
    .week-label { font-size: 13px; font-weight: 600; color: #1f2937; margin: 4px 0; }
    .week-count { font-size: 20px; font-weight: 700; margin: 8px 0; }
    .week-status { font-size: 11px; font-weight: 600; text-transform: uppercase; margin-top: 4px; }
    
    /* Heatmap colors */
    .status-good { background: #d1fae5 !important; border-color: #10b981 !important; }
    .status-good .week-count { color: #065f46 !important; }
    .status-good .week-status { color: #065f46 !important; }
    
    .status-tight { background: #fef3c7 !important; border-color: #f59e0b !important; }
    .status-tight .week-count { color: #92400e !important; }
    .status-tight .week-status { color: #92400e !important; }
    
    .status-critical { background: #fee2e2 !important; border-color: #ef4444 !important; }
    .status-critical .week-count { color: #991b1b !important; }
    .status-critical .week-status { color: #991b1b !important; }
    
    /* Schedule viewer styles */
    .schedule-modal-content { max-width: 95%; width: 1400px; }
    .schedule-grid { overflow-x: auto; }
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .schedule-table th { background: #f9fafb; padding: 10px 8px; text-align: left; font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; border: 1px solid #e5e7eb; white-space: nowrap; }
    .schedule-table td { padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; }
    .schedule-table tr:hover { background: #f9fafb; }
    .schedule-week-complete { background: #d1fae5; }
    .schedule-week-incomplete { background: #fee2e2; }
    .assignment-badge { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #dbeafe; color: #1e40af; }
    .assignment-slot-empty { color: #dc2626; font-style: italic; font-size: 11px; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="header">
      <div>
        <h1>‚öôÔ∏è Admin Panel - PCCM Faculty Hub</h1>
        <p>Comprehensive management for moonlighting and service availability</p>
      </div>
      <a href="/index.html" class="btn-primary">‚Üê Back to Home</a>
    </div>
    
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="showTab('providers')">üë• Manage Providers</button>
      <button class="tab-btn" onclick="showTab('moonlighting')">üåô Moonlighting/IRPA</button>
      <button class="tab-btn" onclick="showTab('overview')">üìä Service Overview</button>
      <button class="tab-btn" onclick="showTab('heatmap')">üî• Unavailability Heatmap</button>
      <button class="tab-btn" onclick="showTab('configure')">‚öôÔ∏è Configure Periods</button>
      <button class="tab-btn" onclick="showTab('requests')">üìà View Requests</button>
      <button class="tab-btn" onclick="showTab('weeks')">üìÖ Manage Weeks</button>
      <button class="tab-btn" onclick="showTab('testing')">üß™ Testing Tools</button>
    </div>
    
    <!-- HEATMAP TAB -->
    <div id="tab-heatmap" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Service Unavailability Heatmap</h2>
          <div class="year-selector">
            <span style="font-weight: 600; color: #6b7280; margin-right: 12px;">Academic Year:</span>
            <button id="year2025Btn" onclick="loadHeatmap(2025)" style="padding: 8px 20px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; color: #6b7280; margin-right: 8px;">2025-2026 (Historic)</button>
            <button id="year2026Btn" onclick="loadHeatmap(2026)" style="padding: 8px 20px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">2026-2027 (Current)</button>
          </div>
        </div>
        
        <div class="heatmap-legend" style="display: flex; gap: 24px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #10b981; background: #d1fae5;"></div>
            <span style="font-size: 13px; font-weight: 600; color: #374151;">Good Staffing</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #f59e0b; background: #fef3c7;"></div>
            <span style="font-size: 13px; font-weight: 600; color: #374151;">Tight Staffing</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #ef4444; background: #fee2e2;"></div>
            <span style="font-size: 13px; font-weight: 600; color: #374151;">Critical Staffing</span>
          </div>
        </div>
        
        <div id="heatmapLoading" class="loading">Loading heatmap...</div>
        <div id="heatmapGrid" class="heatmap-grid" style="display: none;"></div>
      </div>
    </div>
    
    <div id="tab-providers" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Faculty Management</h2>
          <span id="providerCount" style="color: #6b7280;">Loading...</span>
        </div>
        <div id="providerError" class="error-message" style="display: none;"></div>
        <div class="form-grid">
          <div class="form-group"><label>Computing ID</label><input type="text" id="newProviderId" placeholder="jsmith"></div>
          <div class="form-group"><label>Name</label><input type="text" id="newProviderName" placeholder="Dr. Jane Smith"></div>
          <div class="form-group"><label>Email</label><input type="email" id="newProviderEmail" placeholder="smith@virginia.edu"></div>
        </div>
        <button class="btn-primary" onclick="addProvider()">Add Faculty Member</button>
        <div style="margin-top: 30px;">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Rank</th>
                  <th>Effort %</th>
                  <th>Points</th>
                  <th>MICU</th>
                  <th>APP-ICU</th>
                  <th>Procedures</th>
                  <th>Consults</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th style="width: 200px;">Actions</th>
                </tr>
              </thead>
              <tbody id="providersTableBody">
                <tr><td colspan="13" style="text-align: center; padding: 20px;">Loading faculty...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div id="tab-moonlighting" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Moonlighting Schedule Management</h2></div>
        <div id="controls">
          <label>Month: <input type="month" id="monthInput"></label>
          <button class="btn-primary" onclick="loadSignups()">Refresh Signups</button>
          <button class="btn-primary" onclick="runOptimizer()">Run Optimizer</button>
          <button class="btn-secondary" onclick="viewSchedule()">View Schedule</button>
          <button class="btn-secondary" onclick="downloadCsv()">Download CSV</button>
          <button class="btn-danger" onclick="clearMonth()">Clear Month</button>
        </div>
        <div id="summary" style="margin-bottom: 16px; font-size: 0.95rem; background: #f3f4f8; border-radius: 6px; padding: 8px 10px;"><div><strong>Summary for <span id="summaryMonth"></span></strong></div><div id="summaryText">No data loaded yet.</div></div>
        <div><h3 style="margin: 20px 0 10px;">Signups</h3>
          <table><thead><tr><th>Faculty</th><th>Dates Selected</th><th># Dates</th><th>Desired Nights/Mo</th></tr></thead><tbody id="signupsTbody"></tbody></table>
        </div>
        <div id="scheduleSection" style="display:none; margin-top: 30px;"><h3>Generated Schedule</h3><div id="scheduleCalendar"></div></div>
      </div>
    </div>

    
      <!-- Updated Tab Overview -->
      <div id="tab-overview" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Service Availability System Status</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select id="scheduleYearSelect" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600;">
                <option value="2025">2025-2026</option>
                <option value="2026" selected>2026-2027</option>
                <option value="2027">2027-2028</option>
              </select>
              <button class="btn-success" onclick="generateServiceSchedule()" style="padding: 10px 20px;">üóìÔ∏è Generate Schedule</button>
              <button class="btn-primary" onclick="viewServiceSchedule()" style="padding: 10px 20px;">üìã View Schedule</button>
              <button class="btn-secondary" onclick="loadOverview()">üîÑ Refresh</button>
            </div>
          </div>
          <div id="overviewContent"><p style="color: #6b7280;">No weeks generated yet. Configure periods and generate weeks to get started.</p></div>
          
          <!-- Schedule Generation Info -->
          <div style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="margin-bottom: 8px; color: #1f2937;">üìã Inpatient Service Schedule Generation</h4>
            <p style="color: #6b7280; font-size: 13px; line-height: 1.6; margin-bottom: 12px;">
              The schedule generator assigns faculty to the 4 service types based on their allocated weeks. 
              Each faculty can be scheduled ¬±1 week from their target to allow flexibility.
            </p>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #dc2626;">2</div>
                <div style="font-size: 12px; color: #6b7280;">MICU per week</div>
              </div>
              <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">1</div>
                <div style="font-size: 12px; color: #6b7280;">APP-ICU per week</div>
              </div>
              <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #10b981;">1</div>
                <div style="font-size: 12px; color: #6b7280;">Procedures per week</div>
              </div>
              <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">1</div>
                <div style="font-size: 12px; color: #6b7280;">Consults per week</div>
              </div>
            </div>
          </div>
     
    <!-- Capacity Summary Section -->
    <div class="capacity-summary-section" style="margin-top: 30px;">
      <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700;">üìä Service Capacity Overview</h3>
      <div id="capacitySummary">
        <div style="text-align: center; padding: 20px; color: #6b7280;">Loading capacity data...</div>
      </div>
    </div>
  </div>
</div>

    <style>
    .capacity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .capacity-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e5e7eb;
    }

    .capacity-card h4 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #1f2937;
    }

    .capacity-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .capacity-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .capacity-fill {
      height: 100%;
      background: #10b981;
      transition: width 0.3s ease;
    }

    .capacity-fill.not_started { background: #9ca3af; }
    .capacity-fill.in_progress { background: #3b82f6; }
    .capacity-fill.almost_complete { background: #f59e0b; }
    .capacity-fill.complete { background: #10b981; }

    .capacity-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
    }

    .capacity-summary h4 {
      margin-bottom: 16px;
      font-size: 18px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .summary-stat {
      text-align: center;
    }

    .summary-stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .summary-stat-label {
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    </style>
    
    <div id="tab-configure" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Define Special Periods & Generate 52 Weeks</h2></div>
        <div id="configAlert" class="alert"></div>
        <form id="configForm">
          <div class="form-group"><label>Academic Year</label><select id="configYear"><option value="2025">2025-2026</option><option value="2026" selected>2026-2027</option><option value="2027">2027-2028</option></select></div>
          <div class="form-group"><label>Start Date (First Tuesday of July)</label><input type="date" id="configStartDate" value="2026-07-07" required></div>
          <h3 style="margin: 30px 0 20px; color: #1f2937; font-size: 18px;">Special Periods</h3>
          <div class="form-grid">
            <div class="form-group"><label>üèñÔ∏è Summer Start Date</label><input type="date" id="summerStart" value="2026-06-01"><small style="color: #6b7280; font-size: 12px;">Summer typically June-August</small></div>
            <div class="form-group"><label>üèñÔ∏è Summer End Date</label><input type="date" id="summerEnd" value="2026-08-31"></div>
          </div>
          <div class="form-grid">
            <div class="form-group"><label>üå∏ Spring Break Start</label><input type="date" id="springBreak"></div>
            <div class="form-group"><label>ü¶É Thanksgiving Week</label><input type="date" id="thanksgiving"></div>
            <div class="form-group"><label>üéÑ Christmas Week Start</label><input type="date" id="christmas"><small style="color: #6b7280; font-size: 12px;">Will cover 2 weeks</small></div>
          </div>
          <h3 style="margin: 30px 0 20px; color: #1f2937; font-size: 18px;">Conferences</h3>
          <div class="form-grid">
            <div class="form-group"><label>ü´Å ATS Conference</label><input type="date" id="atsConference"><small style="color: #6b7280; font-size: 12px;">American Thoracic Society</small></div>
            <div class="form-group"><label>ü´Å CHEST Conference</label><input type="date" id="chestConference"><small style="color: #6b7280; font-size: 12px;">CHEST Annual Meeting</small></div>
            <div class="form-group"><label>üè• SCCM Conference</label><input type="date" id="sccmConference"><small style="color: #6b7280; font-size: 12px;">Society of Critical Care Medicine</small></div>
          </div>
          <div style="margin-top: 30px; display: flex; gap: 12px;">
            <button type="submit" class="btn-primary">Generate 52 Weeks with Configuration</button>
            <button type="button" class="btn-danger" onclick="clearAllWeeks()">Clear All Weeks</button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="tab-requests" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Service Availability Requests</h2><button class="btn-secondary" onclick="loadRequests()">üîÑ Refresh</button></div>
        <div id="requestsLoading" class="loading">Loading requests...</div>
        <div id="requestsContent" style="display: none;">
          <table><thead><tr><th>Faculty</th><th>Week</th><th>Week Number</th><th>Status</th><th>Points Spent</th><th>Points Earned</th><th>Submitted</th></tr></thead><tbody id="requestsTableBody"></tbody></table>
        </div>
      </div>
    </div>
    
    <div id="tab-weeks" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Edit 52-Week Schedule</h2><button class="btn-secondary" onclick="loadWeeks()">üîÑ Refresh</button></div>
        <div id="weeksLoading" class="loading">Loading weeks...</div>
        <div id="weeksContent" style="display: none;">
          <div style="overflow-x: auto;">
            <table><thead><tr><th style="width: 50px;">#</th><th>Label</th><th>Start Date</th><th>End Date</th><th>Type</th><th style="width: 120px;">Cost (Off)</th><th style="width: 120px;">Reward (Work)</th><th style="width: 100px;">Actions</th></tr></thead><tbody id="weeksTableBody"></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="tab-testing" class="tab-content">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üß™ Testing Utilities</h2>
        <p style="color: #dc2626; font-size: 13px; font-weight: 600;">‚ö†Ô∏è Admin Only - Use for testing workflows</p>
      </div>
      
      <div style="margin-bottom: 40px;">
        <h3 style="margin-bottom: 16px; color: #1f2937;">Faculty Impersonation</h3>
        <p style="color: #6b7280; margin-bottom: 16px; line-height: 1.6;">
          Click "Login As" next to any faculty member in the Manage Providers tab to instantly switch to their account.
          No password required. Perfect for testing the faculty workflow from different perspectives.
        </p>
        <div style="padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
          <strong style="color: #92400e;">üí° Tip:</strong> 
          <span style="color: #78350f;">After testing, logout and log back in as admin to return to admin view.</span>
        </div>
      </div>
      
      <div style="margin-bottom: 40px;">
        <h3 style="margin-bottom: 16px; color: #1f2937;">Reset Utilities</h3>
        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6;">
          Use these tools to reset data between testing cycles. Perfect for testing the point-based allocation system multiple times.
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
          <div style="padding: 24px; background: white; border: 2px solid #e5e7eb; border-radius: 12px;">
            <h4 style="margin-bottom: 12px; color: #1f2937; font-size: 16px;">Reset Faculty Points</h4>
            <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
              Reset all faculty bonus points to 0. Base points remain intact.
            </p>
            <button class="btn-primary" onclick="resetPoints()" style="width: 100%;">Reset All Points</button>
          </div>
          
          <div style="padding: 24px; background: white; border: 2px solid #e5e7eb; border-radius: 12px;">
            <h4 style="margin-bottom: 12px; color: #1f2937; font-size: 16px;">Clear Requests</h4>
            <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
              Delete all unavailability requests. Faculty and weeks remain.
            </p>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Year (optional)</label>
              <input type="number" id="resetYear" placeholder="2026" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
            </div>
            <button class="btn-danger" onclick="resetRequests()" style="width: 100%;">Clear Requests</button>
          </div>
          
          <div style="padding: 24px; background: white; border: 2px solid #e5e7eb; border-radius: 12px;">
            <h4 style="margin-bottom: 12px; color: #1f2937; font-size: 16px;">Complete Reset</h4>
            <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
              Reset points AND clear requests. Fresh start for testing.
            </p>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Year (optional)</label>
              <input type="number" id="resetAllYear" placeholder="2026" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
            </div>
            <button class="btn-danger" onclick="resetAll()" style="width: 100%; background: #dc2626;">Complete Reset</button>
          </div>
        </div>
      </div>
      
      <div id="testingAlert" class="alert"></div>
    </div>
  </div>
  
  <!-- Edit Faculty Modal -->
  <div id="editFacultyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Faculty Member</h3>
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editFacultyForm">
        <input type="hidden" id="editFacultyId">
        <div class="form-group"><label>Name</label><input type="text" id="editName" required></div>
        <div class="form-group"><label>Email</label><input type="email" id="editEmail" required></div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editRank">
            <option value="assistant">Assistant Professor</option>
            <option value="associate">Associate Professor</option>
            <option value="full">Full Professor</option>
          </select>
        </div>
        <div class="form-group">
          <label>Clinical Effort (%)</label>
          <input type="number" id="editEffort" min="0" max="100">
          <small>Percentage of FTE dedicated to clinical work</small>
        </div>
        <div class="form-group">
          <label>Base Points</label>
          <input type="number" id="editPoints" min="0">
          <small>Starting point allocation for service availability requests</small>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="editMoonlighter" style="width: auto; margin-right: 8px;">
            Moonlighter (participates in moonlighting/IRPA shifts)
          </label>
        </div>
        <h4 style="margin: 24px 0 16px; color: #1f2937; font-size: 16px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Expected Clinical Weeks per Year</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>MICU Weeks</label>
            <input type="number" id="editMicuWeeks" min="0" max="52">
            <small>Expected MICU weeks per academic year</small>
          </div>
          <div class="form-group">
            <label>APP-ICU Weeks</label>
            <input type="number" id="editAppIcuWeeks" min="0" max="52">
            <small>Expected APP-ICU weeks per academic year</small>
          </div>
          <div class="form-group">
            <label>Procedure Weeks</label>
            <input type="number" id="editProcedureWeeks" min="0" max="52">
            <small>Expected procedure weeks per academic year</small>
          </div>
          <div class="form-group">
            <label>Consult Weeks</label>
            <input type="number" id="editConsultWeeks" min="0" max="52">
            <small>Expected consult weeks per academic year</small>
          </div>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" class="btn-primary">Save Changes</button>
          <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
// Service Schedule Generation
async function generateServiceSchedule() {
  const year = document.getElementById('scheduleYearSelect').value;
  
  if (!confirm(`Generate inpatient service schedule for ${year}-${parseInt(year)+1}?\n\nThis will:\n‚Ä¢ Clear any existing assignments\n‚Ä¢ Assign faculty to MICU (2/week), APP-ICU (1/week), Procedures (1/week), Consults (1/week)\n‚Ä¢ Respect unavailability requests\n‚Ä¢ Allow ¬±1 week flexibility per service`)) {
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/api/admin/generate-service-schedule`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        year: parseInt(year),
        clear_existing: true
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.detail || 'Failed to generate schedule');
    }
    
    let message = `‚úÖ Schedule Generated!\n\n`;
    message += `‚Ä¢ ${data.assignments_created} assignments created\n`;
    message += `‚Ä¢ ${data.total_weeks} weeks processed\n\n`;
    message += `Summary:\n`;
    message += `‚Ä¢ MICU: ${data.summary.MICU} assignments\n`;
    message += `‚Ä¢ APP-ICU: ${data.summary['APP-ICU']} assignments\n`;
    message += `‚Ä¢ Procedures: ${data.summary.Procedures} assignments\n`;
    message += `‚Ä¢ Consults: ${data.summary.Consults} assignments\n`;
    
    if (data.staffing_issues && data.staffing_issues.length > 0) {
      message += `\n‚ö†Ô∏è Staffing Issues: ${data.staffing_issues.length} weeks understaffed`;
    }
    
    if (data.capacity_issues && data.capacity_issues.length > 0) {
      message += `\n‚ö†Ô∏è Capacity Issues: ${data.capacity_issues.length} faculty over/under target`;
    }
    
    alert(message);
    
    // Refresh the capacity summary
    await loadCapacitySummary();
    
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

// View Service Schedule
async function viewServiceSchedule() {
  const year = document.getElementById('scheduleYearSelect').value;
  const modal = document.getElementById('scheduleModal');
  const content = document.getElementById('scheduleModalContent');
  
  modal.classList.add('show');
  content.innerHTML = '<div class="loading">Loading schedule...</div>';
  
  try {
    const response = await fetch(`${API_BASE}/api/admin/service-schedule?year=${year}`, {
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.detail || 'Failed to load schedule');
    }
    
    if (!data.schedule || data.schedule.length === 0) {
      content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: #6b7280; font-size: 16px;">No schedule generated yet for ${year}-${parseInt(year)+1}.</p>
          <p style="color: #6b7280; font-size: 14px; margin-top: 8px;">Click "Generate Schedule" to create assignments.</p>
        </div>
      `;
      return;
    }
    
    // Build schedule table
    let html = `
      <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>Year:</strong> ${data.year}-${data.year + 1} | 
          <strong>Total Weeks:</strong> ${data.total_weeks} | 
          <strong>Complete Weeks:</strong> ${data.complete_weeks} / ${data.total_weeks} | 
          <strong>Total Assignments:</strong> ${data.total_assignments}
        </div>
        <button class="btn-danger" onclick="clearServiceSchedule(${year})">Clear Schedule</button>
      </div>
      <div class="schedule-grid">
        <table class="schedule-table">
          <thead>
            <tr>
              <th style="width: 50px;">#</th>
              <th style="width: 140px;">Week</th>
              <th style="width: 100px;">Dates</th>
              <th style="width: 80px;">Type</th>
              <th>MICU (2)</th>
              <th>APP-ICU (1)</th>
              <th>Procedures (1)</th>
              <th>Consults (1)</th>
              <th style="width: 80px;">Status</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    data.schedule.forEach(week => {
      const rowClass = week.is_complete ? 'schedule-week-complete' : 'schedule-week-incomplete';
      
      const formatAssignments = (assignments, required) => {
        if (assignments.length === 0) {
          return `<span class="assignment-slot-empty">${required} needed</span>`;
        }
        let html = assignments.map(a => 
          `<span class="assignment-badge">${a.faculty_name}</span>`
        ).join('');
        if (assignments.length < required) {
          html += `<span class="assignment-slot-empty">+${required - assignments.length} needed</span>`;
        }
        return html;
      };
      
      html += `
        <tr class="${rowClass}">
          <td>${week.week_number}</td>
          <td>${week.label}</td>
          <td style="font-size: 11px;">${formatDate(week.start_date)} - ${formatDate(week.end_date)}</td>
          <td style="text-transform: capitalize;">${week.week_type.replace('_', ' ')}</td>
          <td>${formatAssignments(week.assignments.MICU, 2)}</td>
          <td>${formatAssignments(week.assignments['APP-ICU'], 1)}</td>
          <td>${formatAssignments(week.assignments.Procedures, 1)}</td>
          <td>${formatAssignments(week.assignments.Consults, 1)}</td>
          <td>
            <span class="badge ${week.is_complete ? 'badge-active' : 'badge-inactive'}">
              ${week.is_complete ? '‚úì Complete' : 'Incomplete'}
            </span>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table></div>';
    content.innerHTML = html;
    
  } catch (error) {
    content.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
  }
}

async function clearServiceSchedule(year) {
  if (!confirm(`Clear ALL service assignments for ${year}-${parseInt(year)+1}?\n\nThis cannot be undone!`)) {
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/api/admin/service-schedule?year=${year}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.detail || 'Failed to clear schedule');
    }
    
    alert(`‚úÖ Cleared ${data.assignments_deleted} assignments for ${year}-${parseInt(year)+1}`);
    closeScheduleModal();
    await loadCapacitySummary();
    
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

function closeScheduleModal() {
  document.getElementById('scheduleModal').classList.remove('show');
}
</script>
  <!-- Service Schedule Modal -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content schedule-modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Inpatient Service Schedule</h3>
        <span class="close-btn" onclick="closeScheduleModal()">&times;</span>
      </div>
      <div id="scheduleModalContent">
        <div class="loading">Loading schedule...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "";
    let allWeeks = [];
    let allProviders = [];
    let allFaculty = [];
    let currentYear = 2026;
    
    window.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      setDefaultMonth();
      await loadProviders();
      await loadFaculty();
      await loadOverview();
      await loadWeeks();
      await loadCapacitySummary();
    });
    
    async function loadCapacitySummary() {
      try {
        const year = document.getElementById('scheduleYearSelect')?.value || 2026;
        const response = await fetch(`${API_BASE}/api/admin/service-capacity-summary?year=${year}`, {
          credentials: 'include'
        });
        
        if (!response.ok) throw new Error('Failed to load capacity summary');
        
        const data = await response.json();
        
        const html = `
          <div class="capacity-grid">
            ${data.services.map(service => `
              <div class="capacity-card">
                <h4>${service.service_type}</h4>
                <div class="capacity-stats">
                  <span><strong>${service.expected_weeks}</strong> weeks expected</span>
                  <span>${service.faculty_count} faculty</span>
                </div>
                <div class="capacity-bar">
                  <div class="capacity-fill ${service.status}" style="width: ${service.percent_filled}%"></div>
                </div>
                <div class="capacity-stats">
                  <span>${service.assigned_weeks} assigned</span>
                  <span style="color: ${service.remaining_weeks > 0 ? '#ef4444' : '#10b981'};">
                    ${service.remaining_weeks > 0 ? service.remaining_weeks + ' needed' : '‚úì Complete'}
                  </span>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="capacity-summary">
            <h4>Total Capacity (All Services)</h4>
            <div class="summary-grid">
              <div class="summary-stat">
                <div class="summary-stat-value">${data.totals.expected_weeks}</div>
                <div class="summary-stat-label">Expected Weeks</div>
              </div>
              <div class="summary-stat">
                <div class="summary-stat-value">${data.totals.assigned_weeks}</div>
                <div class="summary-stat-label">Assigned Weeks</div>
              </div>
              <div class="summary-stat">
                <div class="summary-stat-value">${data.totals.remaining_weeks}</div>
                <div class="summary-stat-label">Remaining</div>
              </div>
              <div class="summary-stat">
                <div class="summary-stat-value">${data.totals.percent_complete}%</div>
                <div class="summary-stat-label">Complete</div>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('capacitySummary').innerHTML = html;
        
      } catch (error) {
        console.error('Error loading capacity summary:', error);
        document.getElementById('capacitySummary').innerHTML = 
          '<div style="color: #ef4444; padding: 20px;">Failed to load capacity summary</div>';
      }
    }
    
    function setDefaultMonth() {
      const now = new Date();
      const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('monthInput').value = monthStr;
      document.getElementById('summaryMonth').textContent = monthStr;
    }
    
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'same-origin'
        });
        if (!response.ok) { window.location.href = '/'; return; }
        const data = await response.json();
        if (!data.faculty.is_admin) { alert('Access denied. Admin privileges required.'); window.location.href = '/index.html'; }
      } catch (error) { console.error('Auth check failed:', error); window.location.href = '/'; }
    }
    
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'requests') loadRequests();
      if (tabName === 'weeks') loadWeeks();
      if (tabName === 'overview') {
        loadOverview();
        loadCapacitySummary();
      }
      if (tabName === 'heatmap') loadHeatmap(currentYear);
    }
    
    // Service Schedule Generation
    async function generateServiceSchedule() {
      const year = document.getElementById('scheduleYearSelect').value;
      
      if (!confirm(`Generate inpatient service schedule for ${year}-${parseInt(year)+1}?\n\nThis will:\n‚Ä¢ Clear any existing assignments\n‚Ä¢ Assign faculty to MICU (2/week), APP-ICU (1/week), Procedures (1/week), Consults (1/week)\n‚Ä¢ Respect unavailability requests\n‚Ä¢ Allow ¬±1 week flexibility per service`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/admin/generate-service-schedule`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            year: parseInt(year),
            clear_existing: true
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || 'Failed to generate schedule');
        }
        
        let message = `‚úÖ Schedule Generated!\n\n`;
        message += `‚Ä¢ ${data.assignments_created} assignments created\n`;
        message += `‚Ä¢ ${data.total_weeks} weeks processed\n\n`;
        message += `Summary:\n`;
        message += `‚Ä¢ MICU: ${data.summary.MICU} assignments\n`;
        message += `‚Ä¢ APP-ICU: ${data.summary['APP-ICU']} assignments\n`;
        message += `‚Ä¢ Procedures: ${data.summary.Procedures} assignments\n`;
        message += `‚Ä¢ Consults: ${data.summary.Consults} assignments\n`;
        
        if (data.staffing_issues && data.staffing_issues.length > 0) {
          message += `\n‚ö†Ô∏è Staffing Issues: ${data.staffing_issues.length} weeks understaffed`;
        }
        
        if (data.capacity_issues && data.capacity_issues.length > 0) {
          message += `\n‚ö†Ô∏è Capacity Issues: ${data.capacity_issues.length} faculty over/under target`;
        }
        
        alert(message);
        
        // Refresh the capacity summary
        await loadCapacitySummary();
        
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    // View Service Schedule
    async function viewServiceSchedule() {
      const year = document.getElementById('scheduleYearSelect').value;
      const modal = document.getElementById('scheduleModal');
      const content = document.getElementById('scheduleModalContent');
      
      modal.classList.add('show');
      content.innerHTML = '<div class="loading">Loading schedule...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/admin/service-schedule?year=${year}`, {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || 'Failed to load schedule');
        }
        
        if (!data.schedule || data.schedule.length === 0) {
          content.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: #6b7280; font-size: 16px;">No schedule generated yet for ${year}-${parseInt(year)+1}.</p>
              <p style="color: #6b7280; font-size: 14px; margin-top: 8px;">Click "Generate Schedule" to create assignments.</p>
            </div>
          `;
          return;
        }
        
        // Build schedule table
        let html = `
          <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Year:</strong> ${data.year}-${data.year + 1} | 
              <strong>Total Weeks:</strong> ${data.total_weeks} | 
              <strong>Complete Weeks:</strong> ${data.complete_weeks} / ${data.total_weeks} | 
              <strong>Total Assignments:</strong> ${data.total_assignments}
            </div>
            <button class="btn-danger" onclick="clearServiceSchedule(${year})">Clear Schedule</button>
          </div>
          <div class="schedule-grid">
            <table class="schedule-table">
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th style="width: 140px;">Week</th>
                  <th style="width: 100px;">Dates</th>
                  <th style="width: 80px;">Type</th>
                  <th>MICU (2)</th>
                  <th>APP-ICU (1)</th>
                  <th>Procedures (1)</th>
                  <th>Consults (1)</th>
                  <th style="width: 80px;">Status</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        data.schedule.forEach(week => {
          const rowClass = week.is_complete ? 'schedule-week-complete' : 'schedule-week-incomplete';
          
          const formatAssignments = (assignments, required) => {
            if (assignments.length === 0) {
              return `<span class="assignment-slot-empty">${required} needed</span>`;
            }
            let html = assignments.map(a => 
              `<span class="assignment-badge">${a.faculty_name}</span>`
            ).join('');
            if (assignments.length < required) {
              html += `<span class="assignment-slot-empty">+${required - assignments.length} needed</span>`;
            }
            return html;
          };
          
          html += `
            <tr class="${rowClass}">
              <td>${week.week_number}</td>
              <td>${week.label}</td>
              <td style="font-size: 11px;">${formatDate(week.start_date)} - ${formatDate(week.end_date)}</td>
              <td style="text-transform: capitalize;">${week.week_type.replace('_', ' ')}</td>
              <td>${formatAssignments(week.assignments.MICU, 2)}</td>
              <td>${formatAssignments(week.assignments['APP-ICU'], 1)}</td>
              <td>${formatAssignments(week.assignments.Procedures, 1)}</td>
              <td>${formatAssignments(week.assignments.Consults, 1)}</td>
              <td>
                <span class="badge ${week.is_complete ? 'badge-active' : 'badge-inactive'}">
                  ${week.is_complete ? '‚úì Complete' : 'Incomplete'}
                </span>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
        content.innerHTML = html;
        
      } catch (error) {
        content.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      }
    }
    
    async function clearServiceSchedule(year) {
      if (!confirm(`Clear ALL service assignments for ${year}-${parseInt(year)+1}?\n\nThis cannot be undone!`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/admin/service-schedule?year=${year}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || 'Failed to clear schedule');
        }
        
        alert(`‚úÖ

        <div id="scheduleModal" class="modal">
  <div class="modal-content schedule-modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üìã Inpatient Service Schedule</h3>
      <span class="close-btn" onclick="closeScheduleModal()">&times;</span>
    </div>
    <div id="scheduleModalContent">
      <div class="loading">Loading schedule...</div>
    </div>
  </div>
</div>
</body>
