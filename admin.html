<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - PCCM Faculty Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f7f8fc; }
    .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header h1 { font-size: 32px; font-weight: 700; color: #1f2937; }
    .header p { color: #6b7280; margin-top: 4px; }
    .btn-primary { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .btn-danger { padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-secondary { padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 13px; }
    .btn-success { padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 13px; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #6b7280; transition: all 0.2s; font-size: 14px; }
    .tab-btn:hover { color: #1f2937; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
    .card-title { font-size: 20px; font-weight: 700; color: #1f2937; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .alert.show { display: block; }
    .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #e5e7eb; }
    td { padding: 12px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-admin { background: #dbeafe; color: #1e40af; }
    .badge-active { background: #d1fae5; color: #065f46; }
    .badge-inactive { background: #fee2e2; color: #991b1b; }
    .editable-cell { cursor: pointer; position: relative; }
    .editable-cell:hover { background: #f3f4f6; }
    .editable-cell input { padding: 4px 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 13px; }
    .loading { text-align: center; padding: 40px; color: #6b7280; }
    .action-buttons { display: flex; gap: 8px; }
    .error-message { color: #dc2626; background: #fee2e2; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #dc2626; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
    .modal-title { font-size: 20px; font-weight: 700; }
    .close-btn { cursor: pointer; font-size: 24px; color: #6b7280; }
    .close-btn:hover { color: #1f2937; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="header">
      <div>
        <h1>‚öôÔ∏è Admin Panel - PCCM Faculty Hub</h1>
        <p>Comprehensive management for moonlighting and service availability</p>
      </div>
      <a href="/index.html" class="btn-primary">‚Üê Back to Home</a>
    </div>
    
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="showTab('providers')">üë• Manage Providers</button>
      <button class="tab-btn" onclick="showTab('moonlighting')">üåô Moonlighting/IRPA</button>
      <button class="tab-btn" onclick="showTab('overview')">üìä Service Overview</button>
      <button class="tab-btn" onclick="showTab('heatmap')">üî• Unavailability Heatmap</button>
      <button class="tab-btn" onclick="showTab('configure')">‚öôÔ∏è Configure Periods</button>
      <button class="tab-btn" onclick="showTab('requests')">üìà View Requests</button>
      <button class="tab-btn" onclick="showTab('weeks')">üìÖ Manage Weeks</button>
    </div>
    <!-- HEATMAP TAB -->
<div id="tab-heatmap" class="tab-content">
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Service Unavailability Heatmap</h2>
      <div class="year-selector">
        <span style="font-weight: 600; color: #6b7280; margin-right: 12px;">Academic Year:</span>
        <button id="year2025Btn" onclick="loadHeatmap(2025)" style="padding: 8px 20px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; color: #6b7280; margin-right: 8px;">2025-2026 (Historic)</button>
        <button id="year2026Btn" onclick="loadHeatmap(2026)" style="padding: 8px 20px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">2026-2027 (Current)</button>
      </div>
    </div>
    
    <div class="heatmap-legend" style="display: flex; gap: 24px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #10b981; background: #d1fae5;"></div>
        <span style="font-size: 13px; font-weight: 600; color: #374151;">Good Staffing</span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #f59e0b; background: #fef3c7;"></div>
        <span style="font-size: 13px; font-weight: 600; color: #374151;">Tight Staffing</span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #ef4444; background: #fee2e2;"></div>
        <span style="font-size: 13px; font-weight: 600; color: #374151;">Critical Staffing</span>
      </div>
    </div>
    
    <div id="heatmapLoading" class="loading">Loading heatmap...</div>
    <div id="heatmapGrid" style="display: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;"></div>
  </div>
</div>
    
    <div id="tab-providers" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Faculty Management</h2>
          <span id="providerCount" style="color: #6b7280;">Loading...</span>
        </div>
        <div id="providerError" class="error-message" style="display: none;"></div>
        <div class="form-grid">
          <div class="form-group"><label>Computing ID</label><input type="text" id="newProviderId" placeholder="jsmith"></div>
          <div class="form-group"><label>Name</label><input type="text" id="newProviderName" placeholder="Dr. Jane Smith"></div>
          <div class="form-group"><label>Email</label><input type="email" id="newProviderEmail" placeholder="smith@virginia.edu"></div>
        </div>
        <button class="btn-primary" onclick="addProvider()">Add Faculty Member</button>
        <div style="margin-top: 30px;">
          <table><thead><tr><th>Computing ID</th><th>Name</th><th>Email</th><th>Admin</th><th style="width: 200px;">Actions</th></tr></thead><tbody id="providersTableBody"><tr><td colspan="5" style="text-align: center; padding: 20px;">Loading providers...</td></tr></tbody></table>
        </div>
      </div>
    </div>
    
    <div id="tab-moonlighting" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Moonlighting Schedule Management</h2></div>
        <div id="controls">
          <label>Month: <input type="month" id="monthInput"></label>
          <button class="btn-primary" onclick="loadSignups()">Refresh Signups</button>
          <button class="btn-primary" onclick="runOptimizer()">Run Optimizer</button>
          <button class="btn-secondary" onclick="viewSchedule()">View Schedule</button>
          <button class="btn-secondary" onclick="downloadCsv()">Download CSV</button>
          <button class="btn-danger" onclick="clearMonth()">Clear Month</button>
        </div>
        <div id="summary" style="margin-bottom: 16px; font-size: 0.95rem; background: #f3f4f8; border-radius: 6px; padding: 8px 10px;"><div><strong>Summary for <span id="summaryMonth"></span></strong></div><div id="summaryText">No data loaded yet.</div></div>
        <div><h3 style="margin: 20px 0 10px;">Signups</h3>
          <table><thead><tr><th>Faculty</th><th>Dates Selected</th><th># Dates</th><th>Desired Nights/Mo</th></tr></thead><tbody id="signupsTbody"></tbody></table>
        </div>
        <div id="scheduleSection" style="display:none; margin-top: 30px;"><h3>Generated Schedule</h3><div id="scheduleCalendar"></div></div>
      </div>
    </div>
    
    <div id="tab-overview" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Service Availability System Status</h2><button class="btn-secondary" onclick="loadOverview()">üîÑ Refresh</button></div>
        <div id="overviewContent"><p style="color: #6b7280;">No weeks generated yet. Configure periods and generate weeks to get started.</p></div>
      </div>
    </div>
    
    <div id="tab-configure" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Define Special Periods & Generate 52 Weeks</h2></div>
        <div id="configAlert" class="alert"></div>
        <form id="configForm">
          <div class="form-group"><label>Academic Year</label><select id="configYear"><option value="2025">2025-2026</option><option value="2026" selected>2026-2027</option><option value="2027">2027-2028</option></select></div>
          <div class="form-group"><label>Start Date (First Tuesday of July)</label><input type="date" id="configStartDate" value="2026-07-07" required></div>
          <h3 style="margin: 30px 0 20px; color: #1f2937; font-size: 18px;">Special Periods</h3>
          <div class="form-grid">
            <div class="form-group"><label>üèñÔ∏è Summer Start Date</label><input type="date" id="summerStart" value="2026-06-01"><small style="color: #6b7280; font-size: 12px;">Summer typically June-August</small></div>
            <div class="form-group"><label>üèñÔ∏è Summer End Date</label><input type="date" id="summerEnd" value="2026-08-31"></div>
          </div>
          <div class="form-grid">
            <div class="form-group"><label>üå∏ Spring Break Start</label><input type="date" id="springBreak"></div>
            <div class="form-group"><label>ü¶É Thanksgiving Week</label><input type="date" id="thanksgiving"></div>
            <div class="form-group"><label>üéÑ Christmas Week Start</label><input type="date" id="christmas"><small style="color: #6b7280; font-size: 12px;">Will cover 2 weeks</small></div>
          </div>
          <h3 style="margin: 30px 0 20px; color: #1f2937; font-size: 18px;">Conferences</h3>
          <div class="form-grid">
            <div class="form-group"><label>ü´Å ATS Conference</label><input type="date" id="atsConference"><small style="color: #6b7280; font-size: 12px;">American Thoracic Society</small></div>
            <div class="form-group"><label>ü´Å CHEST Conference</label><input type="date" id="chestConference"><small style="color: #6b7280; font-size: 12px;">CHEST Annual Meeting</small></div>
            <div class="form-group"><label>üè• SCCM Conference</label><input type="date" id="sccmConference"><small style="color: #6b7280; font-size: 12px;">Society of Critical Care Medicine</small></div>
          </div>
          <div style="margin-top: 30px; display: flex; gap: 12px;">
            <button type="submit" class="btn-primary">Generate 52 Weeks with Configuration</button>
            <button type="button" class="btn-danger" onclick="clearAllWeeks()">Clear All Weeks</button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="tab-requests" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Service Availability Requests</h2><button class="btn-secondary" onclick="loadRequests()">üîÑ Refresh</button></div>
        <div id="requestsLoading" class="loading">Loading requests...</div>
        <div id="requestsContent" style="display: none;">
          <table><thead><tr><th>Faculty</th><th>Week</th><th>Week Number</th><th>Status</th><th>Points Spent</th><th>Points Earned</th><th>Submitted</th></tr></thead><tbody id="requestsTableBody"></tbody></table>
        </div>
      </div>
    </div>
    
    <div id="tab-weeks" class="tab-content">
      <div class="card">
        <div class="card-header"><h2 class="card-title">Edit 52-Week Schedule</h2><button class="btn-secondary" onclick="loadWeeks()">üîÑ Refresh</button></div>
        <div id="weeksLoading" class="loading">Loading weeks...</div>
        <div id="weeksContent" style="display: none;">
          <div style="overflow-x: auto;">
            <table><thead><tr><th style="width: 50px;">#</th><th>Label</th><th>Start Date</th><th>End Date</th><th>Type</th><th style="width: 120px;">Cost (Off)</th><th style="width: 120px;">Reward (Work)</th><th style="width: 100px;">Actions</th></tr></thead><tbody id="weeksTableBody"></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Faculty Modal -->
  <div id="editFacultyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Faculty Member</h3>
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editFacultyForm">
        <input type="hidden" id="editFacultyId">
        <div class="form-group"><label>Name</label><input type="text" id="editName" required></div>
        <div class="form-group"><label>Email</label><input type="email" id="editEmail" required></div>
        <div class="form-group"><label>Rank</label><select id="editRank"><option value="assistant">Assistant Professor</option><option value="associate">Associate Professor</option><option value="full">Full Professor</option></select></div>
        <div class="form-group"><label>Clinical Effort (%)</label><input type="number" id="editEffort" min="0" max="100"></div>
        <div class="form-group"><label>Base Points</label><input type="number" id="editPoints" min="0"></div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" class="btn-primary">Save Changes</button>
          <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = "";
    let allWeeks = [];
    let allProviders = [];
    let allFaculty = [];
    
    window.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      setDefaultMonth();
      await loadProviders();
      await loadFaculty();
      await loadOverview();
      await loadWeeks();
    });
    
    function setDefaultMonth() {
      const now = new Date();
      const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('monthInput').value = monthStr;
      document.getElementById('summaryMonth').textContent = monthStr;
    }
    
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        if (!response.ok) { window.location.href = '/'; return; }
        const data = await response.json();
        if (!data.faculty.is_admin) { alert('Access denied. Admin privileges required.'); window.location.href = '/index.html'; }
      } catch (error) { console.error('Auth check failed:', error); window.location.href = '/'; }
    }
    
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'requests') loadRequests();
      if (tabName === 'weeks') loadWeeks();
      if (tabName === 'overview') loadOverview();
    }
    
    async function loadProviders() {
      const errorDiv = document.getElementById('providerError');
      const tbody = document.getElementById('providersTableBody');
      const countSpan = document.getElementById('providerCount');
      
      try {
        const response = await fetch('/api/providers');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data)) throw new Error('Invalid response from server');
        
        allProviders = data;
        countSpan.textContent = `${allProviders.length} faculty`;
        errorDiv.style.display = 'none';
        await loadFaculty();
      } catch (error) {
        console.error('Error loading providers:', error);
        errorDiv.textContent = `Error loading providers: ${error.message}`;
        errorDiv.style.display = 'block';
        countSpan.textContent = 'Error';
      }
    }
    
    async function loadFaculty() {
      const tbody = document.getElementById('providersTableBody');
      try {
        const response = await fetch('/api/admin/faculty');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        allFaculty = await response.json();
        
        tbody.innerHTML = '';
        if (allFaculty.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #6b7280;">No faculty yet.</td></tr>';
        } else {
          allFaculty.forEach(f => {
            const row = document.createElement('tr');
            const adminBadge = f.is_admin ? '<span class="badge badge-admin">ADMIN</span>' : '';
            row.innerHTML = `<td>${f.id}</td><td>${f.name}</td><td>${f.email}</td><td>${adminBadge}</td><td><div class="action-buttons"><button class="btn-secondary" onclick="editFaculty('${f.id}')">Edit</button><button class="btn-${f.is_admin ? 'danger' : 'success'}" onclick="toggleAdmin('${f.id}', ${f.is_admin})">${f.is_admin ? 'Remove Admin' : 'Make Admin'}</button><button class="btn-danger" onclick="deleteFaculty('${f.id}', '${f.name}')">Delete</button></div></td>`;
            tbody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading faculty:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #dc2626;">Failed to load faculty.</td></tr>';
      }
    }
    
    function editFaculty(facultyId) {
      const faculty = allFaculty.find(f => f.id === facultyId);
      if (!faculty) return;
      
      document.getElementById('editFacultyId').value = faculty.id;
      document.getElementById('editName').value = faculty.name;
      document.getElementById('editEmail').value = faculty.email;
      document.getElementById('editRank').value = faculty.rank;
      document.getElementById('editEffort').value = faculty.clinical_effort_pct;
      document.getElementById('editPoints').value = faculty.base_points;
      
      document.getElementById('editFacultyModal').classList.add('show');
    }
    
    function closeEditModal() {
      document.getElementById('editFacultyModal').classList.remove('show');
    }
    
    document.getElementById('editFacultyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const facultyId = document.getElementById('editFacultyId').value;
      const updateData = {
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        rank: document.getElementById('editRank').value,
        clinical_effort_pct: parseInt(document.getElementById('editEffort').value),
        base_points: parseInt(document.getElementById('editPoints').value)
      };
      
      try {
        const response = await fetch(`/api/admin/faculty/${facultyId}`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(updateData)
        });
        if (!response.ok) throw new Error('Failed to update faculty');
        alert('Faculty updated successfully');
        closeEditModal();
        await loadFaculty();
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });
    
    async function toggleAdmin(facultyId, isCurrentlyAdmin) {
      const action = isCurrentlyAdmin ? 'remove admin privileges from' : 'grant admin privileges to';
      const faculty = allFaculty.find(f => f.id === facultyId);
      if (!confirm(`${action} ${faculty.name}?`)) return;
      
      try {
        const response = await fetch(`/api/admin/faculty/${facultyId}/toggle-admin`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to toggle admin status');
        alert('Admin status updated');
        await loadFaculty();
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    async function deleteFaculty(facultyId, name) {
      if (!confirm(`Delete faculty '${name}'? This will deactivate their account.`)) return;
      try {
        const response = await fetch(`/api/admin/faculty/${facultyId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete faculty');
        alert(`Faculty '${name}' deactivated`);
        await loadFaculty();
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    async function addProvider() {
      const id = document.getElementById('newProviderId').value.trim();
      const name = document.getElementById('newProviderName').value.trim();
      const email = document.getElementById('newProviderEmail').value.trim();
      if (!id || !name) { alert('Computing ID and Name are required'); return; }
      try {
        const response = await fetch('/api/admin/providers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, name, email: email || null }) });
        if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Failed to add faculty'); }
        alert(`Faculty '${name}' added successfully`);
        document.getElementById('newProviderId').value = '';
        document.getElementById('newProviderName').value = '';
        document.getElementById('newProviderEmail').value = '';
        await loadProviders();
      } catch (error) { alert(`Error: ${error.message}`); }
    }
    
    async function loadSignups() {
      const month = document.getElementById('monthInput').value;
      if (!month) return;
      document.getElementById('summaryMonth').textContent = month;
      document.getElementById('summaryText').textContent = 'Loading...';
      document.getElementById('signupsTbody').innerHTML = '';
      try {
        const response = await fetch(`/api/admin/signups?month=${encodeURIComponent(month)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.length === 0) { document.getElementById('summaryText').textContent = 'No signups yet for this month.'; return; }
        const byProvider = new Map();
        for (const row of data) {
          if (!byProvider.has(row.provider_id)) byProvider.set(row.provider_id, { provider_name: row.provider_name, desired_nights: row.desired_nights, dates: [] });
          byProvider.get(row.provider_id).dates.push(row.date);
        }
        document.getElementById('summaryText').textContent = `${byProvider.size} faculty, ${data.length} faculty-nights`;
        const tbody = document.getElementById('signupsTbody');
        tbody.innerHTML = '';
        const rows = Array.from(byProvider.values()).sort((a, b) => a.provider_name.localeCompare(b.provider_name));
        rows.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${p.provider_name}</td><td>${p.dates.sort().join(', ')}</td><td>${p.dates.length}</td><td>${p.desired_nights}</td>`;
          tbody.appendChild(row);
        });
      } catch (error) { console.error('Error loading signups:', error); document.getElementById('summaryText').textContent = 'Error loading signups.'; }
    }
    
    async function runOptimizer() {
      const month = document.getElementById('monthInput').value;
      if (!month) return;
      try {
        const response = await fetch(`/api/admin/run_optimizer?month=${encodeURIComponent(month)}`, { method: 'POST' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        alert(`Optimizer finished: ${data.assigned_shifts} shifts assigned`);
        await viewSchedule();
      } catch (error) { alert(`Error: ${error.message}`); }
    }
    
    async function viewSchedule() {
      const month = document.getElementById('monthInput').value;
      if (!month) return;
      try {
        const response = await fetch(`/api/admin/assignments?month=${encodeURIComponent(month)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.length === 0) { document.getElementById('scheduleSection').style.display = 'none'; alert('No schedule generated. Run optimizer first.'); return; }
        document.getElementById('scheduleSection').style.display = 'block';
        const [year, monthNum] = month.split('-').map(Number);
        const firstDay = new Date(year, monthNum - 1, 1);
        const lastDay = new Date(year, monthNum, 0);
        const assignmentsByDate = {};
        data.forEach(a => { if (!assignmentsByDate[a.date]) assignmentsByDate[a.date] = []; assignmentsByDate[a.date].push(a.provider_name); });
        let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 12px;">';
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => { html += `<div style="font-weight: 600; background: #f0f0f0; text-align: center; padding: 6px;">${day}</div>`; });
        for (let i = 0; i < firstDay.getDay(); i++) html += '<div style="background: #fafafa; border: 1px solid #ddd; padding: 8px; min-height: 60px;"></div>';
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const providers = assignmentsByDate[dateStr] || [];
          const hasAssignments = providers.length > 0;
          html += `<div style="border: 1px solid #ddd; padding: 8px; min-height: 60px; background: ${hasAssignments ? '#e6f3ff' : 'white'}; font-size: 0.8rem;"><div style="font-weight: 600; margin-bottom: 4px;">${day}</div>`;
          if (hasAssignments) html += providers.map(name => `<div>${name}</div>`).join('');
          html += '</div>';
        }
        html += '</div>';
        document.getElementById('scheduleCalendar').innerHTML = html;
      } catch (error) { console.error('Error loading schedule:', error); }
    }
    
    async function downloadCsv() {
      const month = document.getElementById('monthInput').value;
      if (!month) return;
      try {
        const response = await fetch(`/api/admin/signups_csv?month=${encodeURIComponent(month)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const text = await response.text();
        const blob = new Blob([text], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `signups_${month}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      } catch (error) { alert('Error downloading CSV'); }
    }
    
    async function clearMonth() {
      const month = document.getElementById('monthInput').value;
      if (!confirm(`Clear ALL signups and schedule for ${month}?\n\nThis cannot be undone!`)) return;
      try {
        const response = await fetch(`/api/admin/clear_month?month=${encodeURIComponent(month)}`, { method: 'DELETE' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        alert('Month cleared successfully');
        await loadSignups();
      } catch (error) { alert(`Error: ${error.message}`); }
    }
    
    async function loadOverview() {
      try {
        const response = await fetch('/api/admin/service-weeks');
        const weeks = await response.json();
        const content = document.getElementById('overviewContent');
        if (weeks.length === 0) {
          content.innerHTML = '<p style="color: #6b7280;">No weeks generated yet. Configure periods and generate weeks to get started.</p>';
        } else {
          const types = {};
          weeks.forEach(w => { types[w.week_type] = (types[w.week_type] || 0) + 1; });
          let html = `<p style="margin-bottom: 16px;"><strong>${weeks.length} weeks</strong> generated for academic year ${weeks[0].start_date.substring(0, 4)}</p>`;
          html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
          for (const [type, count] of Object.entries(types)) {
            html += `<div style="padding: 16px; background: #f9fafb; border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: #1f2937;">${count}</div><div style="font-size: 13px; color: #6b7280; text-transform: capitalize;">${type.replace('_', ' ')} weeks</div></div>`;
          }
          html += '</div>';
          content.innerHTML = html;
        }
      } catch (error) { console.error('Error loading overview:', error); }
    }
    
    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const config = {
        year: parseInt(document.getElementById('configYear').value),
        start_date: document.getElementById('configStartDate').value,
        summer_start: document.getElementById('summerStart').value || null,
        summer_end: document.getElementById('summerEnd').value || null,
        spring_break: document.getElementById('springBreak').value || null,
        thanksgiving: document.getElementById('thanksgiving').value || null,
        christmas: document.getElementById('christmas').value || null,
        ats_conference: document.getElementById('atsConference').value || null,
        chest_conference: document.getElementById('chestConference').value || null,
        sccm_conference: document.getElementById('sccmConference').value || null
      };
      try {
        const response = await fetch('/api/admin/generate-service-weeks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) });
        if (response.ok) { showAlert('configAlert', 'Successfully generated 52 weeks!', 'success'); await loadWeeks(); await loadOverview(); showTab('weeks'); }
        else { const error = await response.json(); showAlert('configAlert', error.detail || 'Failed to generate weeks', 'error'); }
      } catch (error) { showAlert('configAlert', 'Error: ' + error.message, 'error'); }
    });
    
    async function clearAllWeeks() {
      if (!confirm('Delete ALL weeks? This will also remove all faculty requests. This cannot be undone.')) return;
      try {
        const response = await fetch('/api/admin/service-weeks', { method: 'DELETE' });
        if (response.ok) { showAlert('configAlert', 'All weeks cleared successfully', 'success'); await loadWeeks(); await loadOverview(); }
        else showAlert('configAlert', 'Failed to clear weeks', 'error');
      } catch (error) { showAlert('configAlert', 'Error: ' + error.message, 'error'); }
    }
    
    async function loadRequests() {
      try {
        const response = await fetch('/api/admin/service-requests');
        const requests = await response.json();
        const tbody = document.getElementById('requestsTableBody');
        tbody.innerHTML = '';
        if (requests.length === 0) { document.getElementById('requestsLoading').innerHTML = '<p style="color: #6b7280;">No requests yet.</p>'; return; }
        requests.forEach(req => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${req.faculty_name}</td><td>${req.week_label}</td><td>${req.week_number}</td><td><span class="badge">${req.status}</span></td><td>${req.points_spent}</td><td>${req.points_earned}</td><td>${new Date(req.created_at).toLocaleDateString()}</td>`;
          tbody.appendChild(row);
        });
        document.getElementById('requestsLoading').style.display = 'none';
        document.getElementById('requestsContent').style.display = 'block';
      } catch (error) { console.error('Error loading requests:', error); }
    }
    
    async function loadWeeks() {
      try {
        const response = await fetch('/api/admin/service-weeks');
        allWeeks = await response.json();
        const tbody = document.getElementById('weeksTableBody');
        tbody.innerHTML = '';
        if (allWeeks.length === 0) { document.getElementById('weeksLoading').innerHTML = '<p style="color: #6b7280;">No weeks generated. Go to Configure Periods tab.</p>'; return; }
        allWeeks.forEach(week => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${week.week_number}</td><td class="editable-cell" onclick="editCell(this, '${week.id}', 'label', 'text')">${week.label}</td><td class="editable-cell" onclick="editCell(this, '${week.id}', 'start_date', 'date')">${formatDate(week.start_date)}</td><td class="editable-cell" onclick="editCell(this, '${week.id}', 'end_date', 'date')">${formatDate(week.end_date)}</td><td><select onchange="updateWeekType('${week.id}', this.value)" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px;"><option value="regular" ${week.week_type === 'regular' ? 'selected' : ''}>Regular</option><option value="summer" ${week.week_type === 'summer' ? 'selected' : ''}>Summer</option><option value="spring_break" ${week.week_type === 'spring_break' ? 'selected' : ''}>Spring Break</option><option value="thanksgiving" ${week.week_type === 'thanksgiving' ? 'selected' : ''}>Thanksgiving</option><option value="christmas" ${week.week_type === 'christmas' ? 'selected' : ''}>Christmas</option><option value="ats" ${week.week_type === 'ats' ? 'selected' : ''}>ATS</option><option value="chest" ${week.week_type === 'chest' ? 'selected' : ''}>CHEST</option><option value="sccm" ${week.week_type === 'sccm' ? 'selected' : ''}>SCCM</option></select></td><td class="editable-cell" onclick="editCell(this, '${week.id}', 'point_cost_off', 'number')">${week.point_cost_off} pts</td><td class="editable-cell" onclick="editCell(this, '${week.id}', 'point_reward_work', 'number')">${week.point_reward_work} pts</td><td><button class="btn-danger" onclick="deleteWeek('${week.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button></td>`;
          tbody.appendChild(row);
        });
        document.getElementById('weeksLoading').style.display = 'none';
        document.getElementById('weeksContent').style.display = 'block';
      } catch (error) { console.error('Error loading weeks:', error); }
    }
    
    function editCell(cell, weekId, field, type) {
      const currentValue = cell.textContent.replace(' pts', '').trim();
      const input = document.createElement('input');
      input.type = type;
      if (type === 'date') input.value = currentValue;
      else if (type === 'number') input.value = parseInt(currentValue);
      else input.value = currentValue;
      input.style.width = '100%';
      input.onblur = () => saveCell(cell, weekId, field, input.value, type);
      input.onkeypress = (e) => { if (e.key === 'Enter') input.blur(); };
      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
    }
    
    async function saveCell(cell, weekId, field, value, type) {
      try {
        const response = await fetch(`/api/admin/service-weeks/${weekId}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({[field]: value}) });
        if (response.ok) {
          if (type === 'number') cell.textContent = value + ' pts';
          else if (type === 'date') cell.textContent = formatDate(value);
          else cell.textContent = value;
          await loadOverview();
        } else { alert('Failed to update'); await loadWeeks(); }
      } catch (error) { alert('Error: ' + error.message); await loadWeeks(); }
    }
    
    async function updateWeekType(weekId, type) {
      try {
        const response = await fetch(`/api/admin/service-weeks/${weekId}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({week_type: type}) });
        if (response.ok) await loadOverview();
        else alert('Failed to update week type');
      } catch (error) { alert('Error: ' + error.message); }
    }
    
    async function deleteWeek(weekId) {
      if (!confirm('Delete this week? This cannot be undone.')) return;
      try {
        const response = await fetch(`/api/admin/service-weeks/${weekId}`, { method: 'DELETE' });
        if (response.ok) { await loadWeeks(); await loadOverview(); }
        else alert('Failed to delete week');
      } catch (error) { alert('Error: ' + error.message); }
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function showAlert(elementId, message, type) {
      const alert = document.getElementById(elementId);
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      setTimeout(() => { alert.classList.remove('show'); }, 5000);
    }
  </script>
</body>
</html>
