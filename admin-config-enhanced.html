<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Service Availability Configuration</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 28px;
      color: #1a202c;
      margin-bottom: 8px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1a202c;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 24px;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #718096;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .heatmap-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 8px;
      margin-top: 20px;
    }
    
    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }
    
    .heatmap-cell:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
    }
    
    /* Color based on number of unavailable faculty */
    .heatmap-cell.low { background: #d1fae5; color: #065f46; }
    .heatmap-cell.medium { background: #fef3c7; color: #92400e; }
    .heatmap-cell.high { background: #fecaca; color: #991b1b; }
    .heatmap-cell.critical { background: #fee2e2; color: #7f1d1d; font-weight: 700; }
    .heatmap-cell.special { border: 3px solid #667eea; }
    
    .week-num { font-size: 18px; margin-bottom: 4px; font-weight: 700; }
    .week-label { font-size: 9px; opacity: 0.7; margin-bottom: 6px; }
    .unavailable-count { 
      font-size: 14px; 
      margin-top: 4px; 
      font-weight: 700;
      padding: 4px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    
    .legend {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .legend-box {
      width: 24px;
      height: 24px;
      border-radius: 4px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 6px;
    }
    
    input, select {
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .upload-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-zone:hover {
      border-color: #667eea;
      background: #f7fafc;
    }
    
    .upload-zone.dragover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    
    .alert.show { display: block; }
    .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
    }
    
    .csv-preview {
      max-height: 300px;
      overflow-y: auto;
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      margin-top: 16px;
    }
    
    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .info-box h3 {
      color: #1e40af;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .csv-example {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 12px 0;
      overflow-x: auto;
    }
    
    .csv-example .header-row {
      color: #059669;
      font-weight: bold;
    }
    
    .csv-example .data-row {
      color: #374151;
    }
    
    .field-desc {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 12px;
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }
    
    .field-name {
      font-weight: 600;
      color: #1f2937;
    }
    
    .field-info {
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öôÔ∏è Service Availability Configuration</h1>
      <p style="color: #718096; margin-top: 8px;">Configure weeks, import historic unavailability data, and visualize demand patterns</p>
    </div>
    
    <!-- Tabs -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('heat-map')">Unavailability Heat Map</button>
        <button class="tab" onclick="switchTab('import')">Import Historic Data</button>
        <button class="tab" onclick="switchTab('configure')">Configure Weeks</button>
      </div>
      
      <!-- Heat Map Tab -->
      <div id="tab-heat-map" class="tab-content active">
        <h2 class="card-title">üìÖ Faculty Unavailability by Week</h2>
        <p style="color: #718096; margin-bottom: 16px; font-size: 14px;">Shows number of faculty requesting to be unavailable for inpatient service each week</p>
        <div id="heatmapAlert" class="alert"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Academic Year</label>
            <select id="heatmapYear" onchange="loadHeatMap()">
              <option value="2025">2025-2026</option>
              <option value="2026" selected>2026-2027</option>
              <option value="2027">2027-2028</option>
            </select>
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button class="btn btn-secondary" onclick="loadHeatMap()">üîÑ Refresh</button>
          </div>
        </div>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box low"></div>
            <span>Low Demand (0-2 unavailable)</span>
          </div>
          <div class="legend-item">
            <div class="legend-box medium"></div>
            <span>Medium Demand (3-5 unavailable)</span>
          </div>
          <div class="legend-item">
            <div class="legend-box high"></div>
            <span>High Demand (6-8 unavailable)</span>
          </div>
          <div class="legend-item">
            <div class="legend-box critical"></div>
            <span>Critical (9+ unavailable)</span>
          </div>
        </div>
        
        <div id="heatmapLoading" class="loading">Loading heat map...</div>
        <div id="heatmapContainer" class="heatmap-container" style="display: none;"></div>
      </div>
      
      <!-- Import Tab -->
      <div id="tab-import" class="tab-content">
        <h2 class="card-title">üìä Import Historic Unavailability Data</h2>
        <div id="importAlert" class="alert"></div>
        
        <div class="info-box">
          <h3>üìã CSV File Format</h3>
          <p style="color: #1e40af; margin-bottom: 12px;">Import historic data showing how many faculty were unavailable each week to identify high-demand periods.</p>
          
          <div class="csv-example">
            <div class="header-row">week_number,unavailable_count</div>
            <div class="data-row">1,3</div>
            <div class="data-row">15,7</div>
            <div class="data-row">25,5</div>
            <div class="data-row">52,9</div>
          </div>
          
          <div style="margin-top: 16px;">
            <strong style="color: #1f2937;">Field Descriptions:</strong>
            
            <div class="field-desc">
              <div class="field-name">week_number</div>
              <div class="field-info">Week number from 1-52 for the academic year</div>
            </div>
            
            <div class="field-desc">
              <div class="field-name">unavailable_count</div>
              <div class="field-info">Total number of faculty unavailable that week</div>
            </div>
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px;">
            <strong style="color: #92400e;">‚ö†Ô∏è Important:</strong>
            <ul style="margin: 8px 0 0 20px; color: #92400e;">
              <li>First row must be the header: <code>week_number,unavailable_count</code></li>
              <li>Each row shows ONE week and the COUNT of unavailable faculty</li>
              <li>Example: Week 15 with 7 faculty unavailable = <code>15,7</code></li>
              <li>Only include weeks with unavailability data (skip weeks with 0)</li>
              <li>Data is processed locally in your browser - nothing is sent to the server</li>
            </ul>
          </div>
        </div>
        
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <div class="upload-zone" onclick="document.getElementById('csvFileInput').click()" 
             ondragover="handleDragOver(event)" 
             ondrop="handleFileDrop(event)" 
             ondragleave="handleDragLeave(event)">
          <div style="font-size: 48px; margin-bottom: 12px;">üìÑ</div>
          <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Drop CSV file here or click to browse</div>
          <div style="color: #718096; font-size: 13px;">Maximum file size: 5MB</div>
        </div>
        
        <div id="csvPreview" class="csv-preview" style="display: none;"></div>
        
        <div id="importActions" style="display: none; margin-top: 20px;">
          <button class="btn btn-primary" onclick="uploadCSV()">‚úÖ Load Data into Heat Map</button>
          <button class="btn btn-secondary" onclick="cancelImport()">Cancel</button>
        </div>
      </div>
      
      <!-- Configure Tab -->
      <div id="tab-configure" class="tab-content">
        <h2 class="card-title">Generate 52-Week Schedule</h2>
        <div id="configAlert" class="alert"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Academic Year</label>
            <select id="academicYear">
              <option value="2025">2025-2026</option>
              <option value="2026" selected>2026-2027</option>
              <option value="2027">2027-2028</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Start Date (First Tuesday of July)</label>
            <input type="date" id="startDate" value="2026-07-07">
          </div>
        </div>
        
        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin: 16px 0;">
          <strong>Optional: Configure Special Periods</strong>
          <div class="form-row" style="margin-top: 12px;">
            <div class="form-group">
              <label>Christmas (2 weeks)</label>
              <input type="date" id="christmas" value="2026-12-22">
            </div>
            <div class="form-group">
              <label>Thanksgiving</label>
              <input type="date" id="thanksgiving" value="2026-11-26">
            </div>
            <div class="form-group">
              <label>Spring Break</label>
              <input type="date" id="springBreak" value="2027-03-15">
            </div>
            <div class="form-group">
              <label>ATS Conference</label>
              <input type="date" id="atsConference" value="2027-05-15">
            </div>
            <div class="form-group">
              <label>CHEST Conference</label>
              <input type="date" id="chestConference" value="2026-10-18">
            </div>
            <div class="form-group">
              <label>SCCM Conference</label>
              <input type="date" id="sccmConference" value="2027-01-24">
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="generateWeeks()">‚ú® Generate 52 Weeks</button>
          <button class="btn btn-danger" onclick="clearWeeks()">üóëÔ∏è Clear All Weeks</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedFile = null;
    let currentTab = 'heat-map';
    let historicData = {}; // Store imported data: {week_number: unavailable_count}
    
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');
      currentTab = tabName;
      
      if (tabName === 'heat-map') {
        loadHeatMap();
      }
    }
    
    // ===== HEAT MAP =====
    
    async function loadHeatMap() {
      const year = parseInt(document.getElementById('heatmapYear').value);
      const container = document.getElementById('heatmapContainer');
      const loading = document.getElementById('heatmapLoading');
      
      loading.style.display = 'block';
      container.style.display = 'none';
      
      try {
        const response = await fetch(`/api/admin/service-weeks/heatmap?year=${year}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        let weeks = Array.isArray(data) ? data : (data.weeks || []);
        
        if (weeks.length === 0) {
          loading.textContent = 'No weeks configured for this year. Use Configure tab to generate weeks.';
          return;
        }
        
        container.innerHTML = '';
        
        weeks.forEach(week => {
          const cell = document.createElement('div');
          
          // Use imported historic data if available, otherwise use current data
          const unavailableCount = historicData[week.week_number] !== undefined ? 
                                   historicData[week.week_number] : 
                                   (week.unavailable_count || 0);
          
          // Determine color based on number of unavailable faculty
          let colorClass = 'low';
          if (unavailableCount >= 9) {
            colorClass = 'critical';
          } else if (unavailableCount >= 6) {
            colorClass = 'high';
          } else if (unavailableCount >= 3) {
            colorClass = 'medium';
          }
          
          cell.className = `heatmap-cell ${colorClass}`;
          
          // Mark special weeks with border
          if (week.week_type !== 'regular' && week.week_type !== 'summer' && week.week_type !== 'premium') {
            cell.classList.add('special');
          }
          
          const dataSource = historicData[week.week_number] !== undefined ? ' (historic)' : '';
          
          cell.innerHTML = `
            <div class="week-num">W${week.week_number}</div>
            <div class="week-label">${week.label.substring(0, 15)}</div>
            <div class="unavailable-count">${unavailableCount} unavailable</div>
          `;
          
          cell.title = `Week ${week.week_number}: ${week.label}\nUnavailable: ${unavailableCount} faculty${dataSource}`;
          
          container.appendChild(cell);
        });
        
        loading.style.display = 'none';
        container.style.display = 'grid';
      } catch (error) {
        console.error('Heat map error:', error);
        showAlert('heatmapAlert', 'Error loading heat map: ' + error.message, 'error');
        loading.textContent = 'Error loading heat map';
      }
    }
    
    // ===== CSV IMPORT (Client-side processing) =====
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) processFile(file);
    }
    
    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.add('dragover');
    }
    
    function handleDragLeave(event) {
      event.currentTarget.classList.remove('dragover');
    }
    
    function handleFileDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.remove('dragover');
      
      const file = event.dataTransfer.files[0];
      if (file) processFile(file);
    }
    
    function processFile(file) {
      if (!file.name.endsWith('.csv')) {
        showAlert('importAlert', 'Please upload a CSV file', 'error');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showAlert('importAlert', 'File too large. Maximum size is 5MB', 'error');
        return;
      }
      
      selectedFile = file;
      
      // Preview file
      const reader = new FileReader();
      reader.onload = (e) => {
        const lines = e.target.result.split('\n').slice(0, 10);
        document.getElementById('csvPreview').innerHTML = `
          <strong>Preview (first 10 lines):</strong><br>
          ${lines.map(line => line.trim()).filter(line => line).join('<br>')}
        `;
        document.getElementById('csvPreview').style.display = 'block';
        document.getElementById('importActions').style.display = 'block';
      };
      reader.readAsText(file);
    }
    
    async function uploadCSV() {
      if (!selectedFile) return;
      
      try {
        showAlert('importAlert', 'Processing CSV...', 'info');
        
        // Read and parse CSV directly in browser (NO backend call)
        const text = await selectedFile.text();
        const lines = text.trim().split('\n');
        
        if (lines.length < 2) {
          showAlert('importAlert', 'CSV file is empty or has no data rows', 'error');
          return;
        }
        
        // Validate header
        const header = lines[0].toLowerCase().trim();
        if (!header.includes('week_number') || !header.includes('unavailable_count')) {
          showAlert('importAlert', 'CSV must have columns: week_number,unavailable_count', 'error');
          return;
        }
        
        // Parse data rows
        historicData = {};
        let recordsImported = 0;
        const errors = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const parts = line.split(',');
          if (parts.length < 2) {
            errors.push(`Row ${i + 1}: Invalid format`);
            continue;
          }
          
          const weekNum = parseInt(parts[0].trim());
          const count = parseInt(parts[1].trim());
          
          if (isNaN(weekNum) || isNaN(count)) {
            errors.push(`Row ${i + 1}: Invalid numbers`);
            continue;
          }
          
          if (weekNum < 1 || weekNum > 52) {
            errors.push(`Row ${i + 1}: Week number must be 1-52`);
            continue;
          }
          
          historicData[weekNum] = count;
          recordsImported++;
        }
        
        let message = `Successfully loaded ${recordsImported} weeks of historic data into heat map!`;
        if (errors.length > 0) {
          message += `\n\nWarnings:\n` + errors.slice(0, 5).join('\n');
          if (errors.length > 5) {
            message += `\n... and ${errors.length - 5} more`;
          }
        }
        
        showAlert('importAlert', message, 'success');
        cancelImport();
        loadHeatMap(); // Refresh heat map with imported data
        
      } catch (error) {
        showAlert('importAlert', 'Error: ' + error.message, 'error');
      }
    }
    
    function cancelImport() {
      selectedFile = null;
      document.getElementById('csvFileInput').value = '';
      document.getElementById('csvPreview').style.display = 'none';
      document.getElementById('importActions').style.display = 'none';
    }
    
    // ===== WEEK CONFIGURATION =====
    
    async function generateWeeks() {
      const year = parseInt(document.getElementById('academicYear').value);
      const startDate = document.getElementById('startDate').value;
      
      if (!startDate) {
        showAlert('configAlert', 'Please select a start date', 'error');
        return;
      }
      
      const payload = {
        year: year,
        start_date: startDate,
        christmas: document.getElementById('christmas').value || null,
        thanksgiving: document.getElementById('thanksgiving').value || null,
        spring_break: document.getElementById('springBreak').value || null,
        ats_conference: document.getElementById('atsConference').value || null,
        chest_conference: document.getElementById('chestConference').value || null,
        sccm_conference: document.getElementById('sccmConference').value || null
      };
      
      try {
        const response = await fetch('/api/admin/generate-service-weeks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showAlert('configAlert', `Successfully generated ${data.weeks_created} weeks!`, 'success');
          loadHeatMap();
        } else {
          showAlert('configAlert', data.detail || 'Failed to generate weeks', 'error');
        }
      } catch (error) {
        showAlert('configAlert', 'Error: ' + error.message, 'error');
      }
    }
    
    async function clearWeeks() {
      if (!confirm('Are you sure you want to delete all weeks? This will also remove all requests and assignments.')) {
        return;
      }
      
      const year = parseInt(document.getElementById('academicYear').value);
      
      try {
        const response = await fetch(`/api/admin/service-weeks?year=${year}`, { method: 'DELETE' });
        
        if (response.ok) {
          showAlert('configAlert', 'All weeks cleared', 'success');
          loadHeatMap();
        } else {
          showAlert('configAlert', 'Failed to clear weeks', 'error');
        }
      } catch (error) {
        showAlert('configAlert', 'Error: ' + error.message, 'error');
      }
    }
    
    // ===== UTILITIES =====
    
    function showAlert(elementId, message, type) {
      const alert = document.getElementById(elementId);
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      setTimeout(() => alert.classList.remove('show'), 7000);
    }
    
    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadHeatMap();
    });
  </script>
</body>
</html>
