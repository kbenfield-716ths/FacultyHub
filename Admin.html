<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRPA Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f6f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #232f3e;
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 600;
    }
    #main {
      max-width: 1200px;
      margin: 16px auto;
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1.4rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    .section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #e0e0e0;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    #controls label {
      font-size: 0.9rem;
    }
    input[type="month"], input[type="text"], input[type="email"] {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #0052cc;
      color: white;
      font-size: 0.9rem;
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
    button.danger {
      background: #dc3545;
      color: white;
    }
    button.edit {
      background: #28a745;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #summary {
      margin-bottom: 16px;
      font-size: 0.95rem;
      background: #f3f4f8;
      border-radius: 6px;
      padding: 8px 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    #status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }
    .calendar-day {
      border: 1px solid #ddd;
      padding: 8px;
      min-height: 60px;
      background: white;
      font-size: 0.8rem;
    }
    .calendar-day-header {
      font-weight: 600;
      background: #f0f0f0;
      text-align: center;
      padding: 6px;
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .calendar-day-empty {
      background: #fafafa;
    }
    .calendar-day-assigned {
      background: #e6f3ff;
    }
    .provider-form {
      display: flex;
      gap: 12px;
      align-items: end;
      margin-top: 12px;
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .form-field label {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .action-buttons {
      display: flex;
      gap: 6px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .close {
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .modal-body {
      margin-bottom: 20px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <header>IRPA Moonlighter – Admin Dashboard</header>

  <div id="main">
    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;">
      <div>
        <h1>Schedule Admin</h1>
        <div id="providerCountLabel" style="font-size:0.85rem;color:#555;"></div>
      </div>
    </div>

    <!-- Schedule Management -->
    <div id="controls">
      <label>
        Month:
        <input type="month" id="monthInput">
      </label>
      <button id="refreshBtn">Refresh signups</button>
      <button id="runOptimizerBtn">Run optimizer</button>
      <button id="viewScheduleBtn" class="secondary">View schedule</button>
      <button id="downloadCsvBtn" class="secondary">Download CSV</button>
      <button id="clearMonthBtn" class="danger">Clear month data</button>
    </div>

    <div id="summary">
      <div><strong>Summary for <span id="summaryMonth"></span></strong></div>
      <div id="summaryText">No data loaded yet.</div>
    </div>

    <div id="tableContainer">
      <h2>Signups</h2>
      <table id="signupsTable">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Dates selected</th>
            <th># Dates</th>
            <th>Desired nights / mo</th>
          </tr>
        </thead>
        <tbody id="signupsTbody"></tbody>
      </table>
    </div>

    <div id="scheduleSection" style="display:none;" class="section">
      <h2>Generated Schedule</h2>
      <div id="scheduleCalendar"></div>
    </div>

    <!-- Provider Management -->
    <div class="section">
      <h2>Provider Management</h2>
      
      <div class="provider-form">
        <div class="form-field">
          <label>Provider ID</label>
          <input type="text" id="newProviderId" placeholder="smith_j">
        </div>
        <div class="form-field">
          <label>Name</label>
          <input type="text" id="newProviderName" placeholder="Dr. Jane Smith">
        </div>
        <div class="form-field">
          <label>Email (optional)</label>
          <input type="email" id="newProviderEmail" placeholder="smith@virginia.edu">
        </div>
        <button id="addProviderBtn">Add Provider</button>
      </div>

      <table style="margin-top:20px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="providersTbody"></tbody>
      </table>
    </div>

    <!-- Danger Zone -->
    <div class="section">
      <h2 style="color:#dc3545;">⚠️ Danger Zone</h2>
      <p style="font-size:0.9rem;color:#666;">These actions cannot be undone.</p>
      <button id="clearAllBtn" class="danger">Clear ALL data (keeps providers)</button>
    </div>

    <div id="status"></div>
  </div>

  <!-- Edit Provider Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Provider</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Provider ID (cannot be changed)</label>
          <input type="text" id="editProviderId" disabled style="background: #f0f0f0;">
        </div>
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Name</label>
          <input type="text" id="editProviderName" placeholder="Dr. Jane Smith">
        </div>
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Email (optional)</label>
          <input type="email" id="editProviderEmail" placeholder="smith@virginia.edu">
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary" id="cancelEditBtn">Cancel</button>
        <button class="edit" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>

 <script>
  const API_BASE = "https://moonlighter-web.fly.dev";
  const monthInput = document.getElementById("monthInput");
  const refreshBtn = document.getElementById("refreshBtn");
  const runOptimizerBtn = document.getElementById("runOptimizerBtn");
  const viewScheduleBtn = document.getElementById("viewScheduleBtn");
  const downloadCsvBtn = document.getElementById("downloadCsvBtn");
  const clearMonthBtn = document.getElementById("clearMonthBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const addProviderBtn = document.getElementById("addProviderBtn");
  const providerCountLabel = document.getElementById("providerCountLabel");
  const summaryMonthSpan = document.getElementById("summaryMonth");
  const summaryText = document.getElementById("summaryText");
  const signupsTbody = document.getElementById("signupsTbody");
  const providersTbody = document.getElementById("providersTbody");
  const statusEl = document.getElementById("status");
  const scheduleSection = document.getElementById("scheduleSection");
  const scheduleCalendar = document.getElementById("scheduleCalendar");

  // Modal elements
  const editModal = document.getElementById("editModal");
  const closeModal = document.querySelector(".close");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const saveEditBtn = document.getElementById("saveEditBtn");
  const editProviderId = document.getElementById("editProviderId");
  const editProviderName = document.getElementById("editProviderName");
  const editProviderEmail = document.getElementById("editProviderEmail");

  function currentMonthString() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  }

  monthInput.value = currentMonthString();
  summaryMonthSpan.textContent = monthInput.value;

  // Modal functions
  function openEditModal(provider) {
    editProviderId.value = provider.id;
    editProviderName.value = provider.name;
    editProviderEmail.value = provider.email || "";
    editModal.style.display = "block";
  }

  function closeEditModal() {
    editModal.style.display = "none";
    editProviderId.value = "";
    editProviderName.value = "";
    editProviderEmail.value = "";
  }

  closeModal.onclick = closeEditModal;
  cancelEditBtn.onclick = closeEditModal;

  window.onclick = function(event) {
    if (event.target == editModal) {
      closeEditModal();
    }
  }

  async function loadProviders() {
    try {
      const res = await fetch(`${API_BASE}/api/providers`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const providers = await res.json();
      providerCountLabel.textContent = `${providers.length} providers in system`;
      
      // Update providers table
      providersTbody.innerHTML = "";
      for (const p of providers) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${p.email || ""}</td>
          <td>
            <div class="action-buttons">
              <button class="edit" onclick="editProvider('${p.id}', '${p.name.replace(/'/g, "\\'")}', '${p.email || ""}')">Edit</button>
              <button class="danger" onclick="deleteProvider('${p.id}', '${p.name.replace(/'/g, "\\'")}')">Delete</button>
            </div>
          </td>
        `;
        providersTbody.appendChild(tr);
      }
    } catch (err) {
      console.error("Error loading providers:", err);
      providerCountLabel.textContent = "Unable to load providers.";
    }
  }

  async function addProvider() {
    const id = document.getElementById("newProviderId").value.trim();
    const name = document.getElementById("newProviderName").value.trim();
    const email = document.getElementById("newProviderEmail").value.trim();

    if (!id || !name) {
      alert("Provider ID and Name are required");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, name, email: email || null })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Failed to add provider");
      }

      statusEl.textContent = `Provider '${name}' added successfully`;
      document.getElementById("newProviderId").value = "";
      document.getElementById("newProviderName").value = "";
      document.getElementById("newProviderEmail").value = "";
      await loadProviders();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  window.editProvider = function(id, name, email) {
    openEditModal({ id, name, email });
  }

  saveEditBtn.onclick = async function() {
    const id = editProviderId.value;
    const name = editProviderName.value.trim();
    const email = editProviderEmail.value.trim();

    if (!name) {
      alert("Name is required");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers/${encodeURIComponent(id)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email: email || null })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Failed to update provider");
      }

      statusEl.textContent = `Provider '${name}' updated successfully`;
      closeEditModal();
      await loadProviders();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function deleteProvider(id, name) {
    if (!confirm(`Delete provider '${name}'?\n\nThis will also delete all their signups and assignments.`)) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers/${encodeURIComponent(id)}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      statusEl.textContent = `Provider '${name}' deleted`;
      await loadProviders();
    } catch (err) {
      alert(`Error deleting provider: ${err.message}`);
    }
  }

  async function clearMonth() {
    const month = monthInput.value;
    if (!confirm(`Clear ALL signups and schedule for ${month}?\n\nThis cannot be undone!`)) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/clear_month?month=${encodeURIComponent(month)}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      
      statusEl.textContent = data.message;
      await loadSignups();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function clearAll() {
    const confirm1 = prompt("Type DELETE_ALL_DATA to confirm clearing ALL schedule data (keeps providers):");
    if (confirm1 !== "DELETE_ALL_DATA") {
      alert("Cancelled");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/clear_all?confirm=DELETE_ALL_DATA`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      
      statusEl.textContent = data.message;
      await loadSignups();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function loadSignups() {
    const month = monthInput.value;
    if (!month) return;
    summaryMonthSpan.textContent = month;
    statusEl.textContent = "Loading signups...";
    signupsTbody.innerHTML = "";
    summaryText.textContent = "Loading...";

    try {
      const url = `${API_BASE}/api/admin/signups?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        summaryText.textContent = "No signups yet for this month.";
        statusEl.textContent = "";
        return;
      }

      const byProvider = new Map();
      for (const row of data) {
        if (!byProvider.has(row.provider_id)) {
          byProvider.set(row.provider_id, {
            provider_id: row.provider_id,
            provider_name: row.provider_name,
            desired_nights: row.desired_nights,
            dates: [],
          });
        }
        byProvider.get(row.provider_id).dates.push(row.date);
      }

      summaryText.textContent = `${byProvider.size} providers, ${data.length} provider-nights`;

      signupsTbody.innerHTML = "";
      const rows = Array.from(byProvider.values()).sort((a, b) =>
        a.provider_name.localeCompare(b.provider_name)
      );

      for (const p of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.provider_name}</td>
          <td>${p.dates.sort().join(", ")}</td>
          <td>${p.dates.length}</td>
          <td>${p.desired_nights}</td>
        `;
        signupsTbody.appendChild(tr);
      }

      statusEl.textContent = "Signups loaded.";
    } catch (err) {
      console.error("Error loading signups:", err);
      summaryText.textContent = "Error loading signups.";
      statusEl.textContent = "Error loading signups from backend.";
    }
  }

  async function runOptimizer() {
    const month = monthInput.value;
    if (!month) return;

    statusEl.textContent = "Running optimizer...";
    runOptimizerBtn.disabled = true;

    try {
      const params = new URLSearchParams({ month });
      const url = `${API_BASE}/api/admin/run_optimizer?${params.toString()}`;
      const res = await fetch(url, { method: "POST" });
      const text = await res.text();

      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);

      const data = JSON.parse(text);
      statusEl.textContent = `Optimizer finished: ${data.assigned_shifts} shifts assigned. Click 'View schedule'.`;
      await viewSchedule();
    } catch (err) {
      console.error("Error running optimizer:", err);
      statusEl.textContent = "Error running optimizer.";
    } finally {
      runOptimizerBtn.disabled = false;
    }
  }

  async function viewSchedule() {
    const month = monthInput.value;
    if (!month) return;

    try {
      const url = `${API_BASE}/api/admin/assignments?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        scheduleSection.style.display = "none";
        statusEl.textContent = "No schedule generated. Run optimizer first.";
        return;
      }

      scheduleSection.style.display = "block";
      
      const [year, monthNum] = month.split("-").map(Number);
      const firstDay = new Date(year, monthNum - 1, 1);
      const lastDay = new Date(year, monthNum, 0);
      
      const assignmentsByDate = {};
      for (const a of data) {
        if (!assignmentsByDate[a.date]) assignmentsByDate[a.date] = [];
        assignmentsByDate[a.date].push(a.provider_name);
      }

      let html = '<div class="calendar-grid">';
      
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });

      for (let i = 0; i < firstDay.getDay(); i++) {
        html += '<div class="calendar-day calendar-day-empty"></div>';
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const providers = assignmentsByDate[dateStr] || [];
        const hasAssignments = providers.length > 0;
        
        html += `<div class="calendar-day ${hasAssignments ? 'calendar-day-assigned' : ''}">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        if (hasAssignments) {
          html += providers.map(name => `<div>${name}</div>`).join('');
        }
        html += '</div>';
      }

      html += '</div>';
      scheduleCalendar.innerHTML = html;
      statusEl.textContent = `Schedule: ${data.length} assignments`;

    } catch (err) {
      console.error("Error loading schedule:", err);
      statusEl.textContent = "Error loading schedule.";
    }
  }

  async function downloadCsv() {
    const month = monthInput.value;
    if (!month) return;

    try {
      const res = await fetch(`${API_BASE}/api/admin/signups_csv?month=${encodeURIComponent(month)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      const blob = new Blob([text], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `signups_${month}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      statusEl.textContent = "CSV downloaded.";
    } catch (err) {
      alert("Error downloading CSV");
    }
  }

  // Event listeners
  refreshBtn.addEventListener("click", loadSignups);
  runOptimizerBtn.addEventListener("click", runOptimizer);
  viewScheduleBtn.addEventListener("click", viewSchedule);
  downloadCsvBtn.addEventListener("click", downloadCsv);
  clearMonthBtn.addEventListener("click", clearMonth);
  clearAllBtn.addEventListener("click", clearAll);
  addProviderBtn.addEventListener("click", addProvider);
  window.deleteProvider = deleteProvider; // Make available to inline onclick

  // Initial load
  loadProviders();
  loadSignups();
</script>
</body>
</html>
