<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRPA Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f6f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #232f3e;
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 600;
    }
    #main {
      max-width: 1200px;
      margin: 16px auto;
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1.4rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    .section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #e0e0e0;
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #0052cc;
    }
    .section-header h2 {
      margin: 0;
      flex: 1;
      color: #0052cc;
    }
    .section-icon {
      font-size: 1.4rem;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    #controls label {
      font-size: 0.9rem;
    }
    input[type="month"], input[type="text"], input[type="email"], input[type="number"] {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #0052cc;
      color: white;
      font-size: 0.9rem;
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
    button.danger {
      background: #dc3545;
      color: white;
    }
    button.edit {
      background: #28a745;
      color: white;
    }
    button.back {
      background: #666;
      color: white;
      padding: 8px 16px;
    }
    button.back:hover {
      background: #555;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    button:hover:not(:disabled) {
      opacity: 0.9;
    }
    #summary {
      margin-bottom: 16px;
      font-size: 0.95rem;
      background: #f3f4f8;
      border-radius: 6px;
      padding: 8px 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    #status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }
    .calendar-day {
      border: 1px solid #ddd;
      padding: 8px;
      min-height: 60px;
      background: white;
      font-size: 0.8rem;
    }
    .calendar-day-header {
      font-weight: 600;
      background: #f0f0f0;
      text-align: center;
      padding: 6px;
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .calendar-day-empty {
      background: #fafafa;
    }
    .calendar-day-assigned {
      background: #e6f3ff;
    }
    .provider-form {
      display: flex;
      gap: 12px;
      align-items: end;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .form-field label {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .action-buttons {
      display: flex;
      gap: 6px;
    }
    
    /* Unavailable weeks section styles */
    .weeks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .week-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      background: #f9f9f9;
    }
    .week-card-header {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    .week-dates {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 8px;
    }
    .week-actions {
      display: flex;
      gap: 6px;
    }
    .week-actions button {
      flex: 1;
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .close {
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .modal-body {
      margin-bottom: 20px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <header>IRPA Moonlighter ‚Äì Admin Dashboard</header>

  <div id="main">
    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;">
      <div>
        <h1>Schedule Admin</h1>
        <div id="providerCountLabel" style="font-size:0.85rem;color:#555;"></div>
      </div>
      <button id="backToHomeBtn" class="back">‚Üê Back to Home</button>
    </div>

    <!-- ========== SECTION 1: FACULTY MANAGEMENT ========== -->
    <div class="section">
      <div class="section-header">
        <span class="section-icon">üë•</span>
        <h2>Faculty Management</h2>
      </div>
      
      <div class="provider-form">
        <div class="form-field">
          <label>Provider ID</label>
          <input type="text" id="newProviderId" placeholder="smith_j">
        </div>
        <div class="form-field">
          <label>Name</label>
          <input type="text" id="newProviderName" placeholder="Dr. Jane Smith">
        </div>
        <div class="form-field">
          <label>Email (optional)</label>
          <input type="email" id="newProviderEmail" placeholder="smith@virginia.edu">
        </div>
        <button id="addProviderBtn">Add Faculty</button>
      </div>

      <table style="margin-top:20px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="providersTbody"></tbody>
      </table>
    </div>

    <!-- ========== SECTION 2: MOONLIGHTING ========== -->
    <div class="section">
      <div class="section-header">
        <span class="section-icon">üåô</span>
        <h2>Moonlighting Schedule</h2>
      </div>

      <div id="controls">
        <label>
          Month:
          <input type="month" id="monthInput">
        </label>
        <button id="refreshBtn">Refresh Signups</button>
        <button id="runOptimizerBtn">Run Optimizer</button>
        <button id="viewScheduleBtn" class="secondary">View Schedule</button>
        <button id="downloadCsvBtn" class="secondary">Download CSV</button>
        <button id="clearMonthBtn" class="danger">Clear Month</button>
      </div>

      <div id="summary">
        <div><strong>Summary for <span id="summaryMonth"></span></strong></div>
        <div id="summaryText">No data loaded yet.</div>
      </div>

      <div id="tableContainer">
        <h3>Signups</h3>
        <table id="signupsTable">
          <thead>
            <tr>
              <th>Faculty</th>
              <th>Dates Selected</th>
              <th># Dates</th>
              <th>Desired Nights/Mo</th>
            </tr>
          </thead>
          <tbody id="signupsTbody"></tbody>
        </table>
      </div>

      <div id="scheduleSection" style="display:none;">
        <h3>Generated Schedule</h3>
        <div id="scheduleCalendar"></div>
      </div>
    </div>

    <!-- ========== SECTION 3: YEARLY CALENDAR BUILD ========== -->
    <div class="section">
      <div class="section-header">
        <span class="section-icon">üìÖ</span>
        <h2>Yearly Calendar Build</h2>
      </div>
      
      <p style="font-size:0.9rem;color:#666;margin-bottom:16px;">
        Define unavailable weeks across the year. These blocks represent periods when faculty are unavailable for moonlighting (e.g., vacation, conferences, research blocks).
      </p>

      <div class="provider-form">
        <div class="form-field">
          <label>Start Date</label>
          <input type="date" id="weekStartDate">
        </div>
        <div class="form-field">
          <label>End Date</label>
          <input type="date" id="weekEndDate">
        </div>
        <div class="form-field">
          <label>Label (e.g., "Summer Break")</label>
          <input type="text" id="weekLabel" placeholder="e.g., Summer Break, Conference">
        </div>
        <button id="addWeekBtn">Add Unavailable Period</button>
      </div>

      <div id="unavailableWeeksContainer">
        <h3>Unavailable Periods</h3>
        <div id="unavailableWeeksList" class="weeks-grid">
          <div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px 20px;">
            No unavailable periods defined yet.
          </div>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="section">
      <h2 style="color:#dc3545;">‚ö†Ô∏è Danger Zone</h2>
      <p style="font-size:0.9rem;color:#666;">These actions cannot be undone.</p>
      <button id="clearAllBtn" class="danger">Clear ALL Data (keeps faculty)</button>
    </div>

    <div id="status"></div>
  </div>

  <!-- Edit Faculty Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Faculty</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Faculty ID (cannot be changed)</label>
          <input type="text" id="editProviderId" disabled style="background: #f0f0f0;">
        </div>
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Name</label>
          <input type="text" id="editProviderName" placeholder="Dr. Jane Smith">
        </div>
        <div class="form-field" style="margin-bottom: 12px;">
          <label>Email (optional)</label>
          <input type="email" id="editProviderEmail" placeholder="smith@virginia.edu">
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary" id="cancelEditBtn">Cancel</button>
        <button class="edit" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>

 <script>
  const API_BASE = "https://moonlighter-web.fly.dev";
  const monthInput = document.getElementById("monthInput");
  const refreshBtn = document.getElementById("refreshBtn");
  const runOptimizerBtn = document.getElementById("runOptimizerBtn");
  const viewScheduleBtn = document.getElementById("viewScheduleBtn");
  const downloadCsvBtn = document.getElementById("downloadCsvBtn");
  const clearMonthBtn = document.getElementById("clearMonthBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const addProviderBtn = document.getElementById("addProviderBtn");
  const backToHomeBtn = document.getElementById("backToHomeBtn");
  const addWeekBtn = document.getElementById("addWeekBtn");
  const providerCountLabel = document.getElementById("providerCountLabel");
  const summaryMonthSpan = document.getElementById("summaryMonth");
  const summaryText = document.getElementById("summaryText");
  const signupsTbody = document.getElementById("signupsTbody");
  const providersTbody = document.getElementById("providersTbody");
  const statusEl = document.getElementById("status");
  const scheduleSection = document.getElementById("scheduleSection");
  const scheduleCalendar = document.getElementById("scheduleCalendar");
  const unavailableWeeksList = document.getElementById("unavailableWeeksList");

  // Modal elements
  const editModal = document.getElementById("editModal");
  const closeModal = document.querySelector(".close");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const saveEditBtn = document.getElementById("saveEditBtn");
  const editProviderId = document.getElementById("editProviderId");
  const editProviderName = document.getElementById("editProviderName");
  const editProviderEmail = document.getElementById("editProviderEmail");

  // Unavailable weeks storage (in memory for now)
  let unavailableWeeks = JSON.parse(localStorage.getItem("unavailableWeeks") || "[]");

  function currentMonthString() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  }

  monthInput.value = currentMonthString();
  summaryMonthSpan.textContent = monthInput.value;

  // Back to Home button
  backToHomeBtn.addEventListener("click", function() {
    window.location.href = "/index.html";
  });

  // Modal functions
  function openEditModal(provider) {
    editProviderId.value = provider.id;
    editProviderName.value = provider.name;
    editProviderEmail.value = provider.email || "";
    editModal.style.display = "block";
  }

  function closeEditModal() {
    editModal.style.display = "none";
    editProviderId.value = "";
    editProviderName.value = "";
    editProviderEmail.value = "";
  }

  closeModal.onclick = closeEditModal;
  cancelEditBtn.onclick = closeEditModal;

  window.onclick = function(event) {
    if (event.target == editModal) {
      closeEditModal();
    }
  }

  // ========== UNAVAILABLE WEEKS MANAGEMENT ==========

  function saveUnavailableWeeks() {
    localStorage.setItem("unavailableWeeks", JSON.stringify(unavailableWeeks));
  }

  function renderUnavailableWeeks() {
    if (unavailableWeeks.length === 0) {
      unavailableWeeksList.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px 20px;">
          No unavailable periods defined yet.
        </div>
      `;
      return;
    }

    unavailableWeeksList.innerHTML = "";
    
    unavailableWeeks.forEach((week, index) => {
      const card = document.createElement("div");
      card.className = "week-card";
      
      const startDate = new Date(week.start);
      const endDate = new Date(week.end);
      const daysCount = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      
      const formatDate = (d) => d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
      
      card.innerHTML = `
        <div class="week-card-header">${week.label}</div>
        <div class="week-dates">
          <strong>Duration:</strong> ${daysCount} days<br>
          ${formatDate(startDate)} to ${formatDate(endDate)}
        </div>
        <div class="week-actions">
          <button class="secondary" onclick="editWeek(${index})">Edit</button>
          <button class="danger" onclick="deleteWeek(${index})">Delete</button>
        </div>
      `;
      unavailableWeeksList.appendChild(card);
    });
  }

  window.editWeek = function(index) {
    const week = unavailableWeeks[index];
    document.getElementById("weekStartDate").value = week.start;
    document.getElementById("weekEndDate").value = week.end;
    document.getElementById("weekLabel").value = week.label;
    
    // Mark for editing
    addWeekBtn.dataset.editIndex = index;
    addWeekBtn.textContent = "Update Period";
  };

  window.deleteWeek = function(index) {
    if (confirm("Delete this unavailable period?")) {
      unavailableWeeks.splice(index, 1);
      saveUnavailableWeeks();
      renderUnavailableWeeks();
      statusEl.textContent = "Period deleted.";
    }
  };

  addWeekBtn.addEventListener("click", function() {
    const startDate = document.getElementById("weekStartDate").value;
    const endDate = document.getElementById("weekEndDate").value;
    const label = document.getElementById("weekLabel").value.trim();

    if (!startDate || !endDate || !label) {
      alert("All fields are required");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      alert("Start date must be before end date");
      return;
    }

    const editIndex = addWeekBtn.dataset.editIndex;

    if (editIndex !== undefined) {
      // Update existing
      unavailableWeeks[parseInt(editIndex)] = { start: startDate, end: endDate, label };
      delete addWeekBtn.dataset.editIndex;
      addWeekBtn.textContent = "Add Unavailable Period";
      statusEl.textContent = "Period updated.";
    } else {
      // Add new
      unavailableWeeks.push({ start: startDate, end: endDate, label });
      statusEl.textContent = "Period added.";
    }

    saveUnavailableWeeks();
    renderUnavailableWeeks();
    
    // Clear form
    document.getElementById("weekStartDate").value = "";
    document.getElementById("weekEndDate").value = "";
    document.getElementById("weekLabel").value = "";
  });

  // ========== FACULTY MANAGEMENT ==========

  async function loadProviders() {
    try {
      const res = await fetch(`${API_BASE}/api/providers`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const providers = await res.json();
      providerCountLabel.textContent = `${providers.length} faculty in system`;
      
      // Update providers table
      providersTbody.innerHTML = "";
      for (const p of providers) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${p.email || ""}</td>
          <td>
            <div class="action-buttons">
              <button class="edit" onclick="editProvider('${p.id}', '${p.name.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${(p.email || "").replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">Edit</button>
              <button class="danger" onclick="deleteProvider('${p.id}', '${p.name.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">Delete</button>
            </div>
          </td>
        `;
        providersTbody.appendChild(tr);
      }
    } catch (err) {
      console.error("Error loading providers:", err);
      providerCountLabel.textContent = "Unable to load providers.";
    }
  }

  async function addProvider() {
    const id = document.getElementById("newProviderId").value.trim();
    const name = document.getElementById("newProviderName").value.trim();
    const email = document.getElementById("newProviderEmail").value.trim();

    if (!id || !name) {
      alert("Faculty ID and Name are required");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, name, email: email || null })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Failed to add faculty");
      }

      statusEl.textContent = `Faculty '${name}' added successfully`;
      document.getElementById("newProviderId").value = "";
      document.getElementById("newProviderName").value = "";
      document.getElementById("newProviderEmail").value = "";
      await loadProviders();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  window.editProvider = function(id, name, email) {
    openEditModal({ id, name, email });
  }

  saveEditBtn.onclick = async function() {
    const id = editProviderId.value;
    const name = editProviderName.value.trim();
    const email = editProviderEmail.value.trim();

    if (!name) {
      alert("Name is required");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers/${encodeURIComponent(id)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email: email || null })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Failed to update faculty");
      }

      statusEl.textContent = `Faculty '${name}' updated successfully`;
      closeEditModal();
      await loadProviders();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function deleteProvider(id, name) {
    if (!confirm(`Delete faculty '${name}'?\n\nThis will also delete all their signups and assignments.`)) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/providers/${encodeURIComponent(id)}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      statusEl.textContent = `Faculty '${name}' deleted`;
      await loadProviders();
    } catch (err) {
      alert(`Error deleting faculty: ${err.message}`);
    }
  }

  // ========== MOONLIGHTING MANAGEMENT ==========

  async function clearMonth() {
    const month = monthInput.value;
    if (!confirm(`Clear ALL signups and schedule for ${month}?\n\nThis cannot be undone!`)) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/clear_month?month=${encodeURIComponent(month)}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      
      statusEl.textContent = data.message;
      await loadSignups();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function clearAll() {
    const confirm1 = prompt("Type DELETE_ALL_DATA to confirm clearing ALL schedule data (keeps faculty):");
    if (confirm1 !== "DELETE_ALL_DATA") {
      alert("Cancelled");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/clear_all?confirm=DELETE_ALL_DATA`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      
      statusEl.textContent = data.message;
      await loadSignups();
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }

  async function loadSignups() {
    const month = monthInput.value;
    if (!month) return;
    summaryMonthSpan.textContent = month;
    statusEl.textContent = "Loading signups...";
    signupsTbody.innerHTML = "";
    summaryText.textContent = "Loading...";

    try {
      const url = `${API_BASE}/api/admin/signups?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        summaryText.textContent = "No signups yet for this month.";
        statusEl.textContent = "";
        return;
      }

      const byProvider = new Map();
      for (const row of data) {
        if (!byProvider.has(row.provider_id)) {
          byProvider.set(row.provider_id, {
            provider_id: row.provider_id,
            provider_name: row.provider_name,
            desired_nights: row.desired_nights,
            dates: [],
          });
        }
        byProvider.get(row.provider_id).dates.push(row.date);
      }

      summaryText.textContent = `${byProvider.size} faculty, ${data.length} faculty-nights`;

      signupsTbody.innerHTML = "";
      const rows = Array.from(byProvider.values()).sort((a, b) =>
        a.provider_name.localeCompare(b.provider_name)
      );

      for (const p of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.provider_name}</td>
          <td>${p.dates.sort().join(", ")}</td>
          <td>${p.dates.length}</td>
          <td>${p.desired_nights}</td>
        `;
        signupsTbody.appendChild(tr);
      }

      statusEl.textContent = "Signups loaded.";
    } catch (err) {
      console.error("Error loading signups:", err);
      summaryText.textContent = "Error loading signups.";
      statusEl.textContent = "Error loading signups from backend.";
    }
  }

  async function runOptimizer() {
    const month = monthInput.value;
    if (!month) return;

    statusEl.textContent = "Running optimizer...";
    runOptimizerBtn.disabled = true;

    try {
      const params = new URLSearchParams({ month });
      const url = `${API_BASE}/api/admin/run_optimizer?${params.toString()}`;
      const res = await fetch(url, { method: "POST" });
      const text = await res.text();

      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);

      const data = JSON.parse(text);
      statusEl.textContent = `Optimizer finished: ${data.assigned_shifts} shifts assigned. Click 'View Schedule'.`;
      await viewSchedule();
    } catch (err) {
      console.error("Error running optimizer:", err);
      statusEl.textContent = "Error running optimizer.";
    } finally {
      runOptimizerBtn.disabled = false;
    }
  }

  async function viewSchedule() {
    const month = monthInput.value;
    if (!month) return;

    try {
      const url = `${API_BASE}/api/admin/assignments?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        scheduleSection.style.display = "none";
        statusEl.textContent = "No schedule generated. Run optimizer first.";
        return;
      }

      scheduleSection.style.display = "block";
      
      const [year, monthNum] = month.split("-").map(Number);
      const firstDay = new Date(year, monthNum - 1, 1);
      const lastDay = new Date(year, monthNum, 0);
      
      const assignmentsByDate = {};
      for (const a of data) {
        if (!assignmentsByDate[a.date]) assignmentsByDate[a.date] = [];
        assignmentsByDate[a.date].push(a.provider_name);
      }

      let html = '<div class="calendar-grid">';
      
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });

      for (let i = 0; i < firstDay.getDay(); i++) {
        html += '<div class="calendar-day calendar-day-empty"></div>';
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const providers = assignmentsByDate[dateStr] || [];
        const hasAssignments = providers.length > 0;
        
        html += `<div class="calendar-day ${hasAssignments ? 'calendar-day-assigned' : ''}">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        if (hasAssignments) {
          html += providers.map(name => `<div>${name}</div>`).join('');
        }
        html += '</div>';
      }

      html += '</div>';
      scheduleCalendar.innerHTML = html;
      statusEl.textContent = `Schedule: ${data.length} assignments`;

    } catch (err) {
      console.error("Error loading schedule:", err);
      statusEl.textContent = "Error loading schedule.";
    }
  }

  async function downloadCsv() {
    const month = monthInput.value;
    if (!month) return;

    try {
      const res = await fetch(`${API_BASE}/api/admin/signups_csv?month=${encodeURIComponent(month)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const text = await res.text();
      const blob = new Blob([text], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `signups_${month}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      statusEl.textContent = "CSV downloaded.";
    } catch (err) {
      alert("Error downloading CSV");
    }
  }

  // Event listeners
  refreshBtn.addEventListener("click", loadSignups);
  runOptimizerBtn.addEventListener("click", runOptimizer);
  viewScheduleBtn.addEventListener("click", viewSchedule);
  downloadCsvBtn.addEventListener("click", downloadCsv);
  clearMonthBtn.addEventListener("click", clearMonth);
  clearAllBtn.addEventListener("click", clearAll);
  addProviderBtn.addEventListener("click", addProvider);
  window.deleteProvider = deleteProvider;

  // Initial load
  loadProviders();
  loadSignups();
  renderUnavailableWeeks();
</script>
</body>
</html>
