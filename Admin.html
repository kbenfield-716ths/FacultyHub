<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRPA Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f6f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #232f3e;
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 600;
    }
    #main {
      max-width: 1200px;
      margin: 16px auto;
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1.4rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    #controls label {
      font-size: 0.9rem;
    }
    input[type="month"] {
      padding: 4px 6px;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #0052cc;
      color: white;
      font-size: 0.9rem;
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #summary {
      margin-bottom: 16px;
      font-size: 0.95rem;
      background: #f3f4f8;
      border-radius: 6px;
      padding: 8px 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    #status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
    }
    #scheduleSection {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #e0e0e0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }
    .calendar-day {
      border: 1px solid #ddd;
      padding: 8px;
      min-height: 60px;
      background: white;
      font-size: 0.8rem;
    }
    .calendar-day-header {
      font-weight: 600;
      background: #f0f0f0;
      text-align: center;
      padding: 6px;
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .calendar-day-empty {
      background: #fafafa;
    }
    .calendar-day-assigned {
      background: #e6f3ff;
    }
  </style>
</head>
<body>
  <header>IRPA Moonlighter â€“ Admin Dashboard</header>

  <div id="main">
    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;">
      <div>
        <h1>Schedule Admin</h1>
        <div id="providerCountLabel" style="font-size:0.85rem;color:#555;"></div>
      </div>
    </div>

    <div id="controls">
      <label>
        Month:
        <input type="month" id="monthInput">
      </label>
      <button id="refreshBtn">Refresh signups</button>
      <button id="runOptimizerBtn">Run optimizer for month</button>
      <button id="viewScheduleBtn" class="secondary">View schedule</button>
      <button id="downloadCsvBtn" class="secondary">Download signups CSV</button>
    </div>

    <div id="summary">
      <div><strong>Summary for <span id="summaryMonth"></span></strong></div>
      <div id="summaryText">No data loaded yet.</div>
    </div>

    <div id="tableContainer">
      <h2>Signups</h2>
      <table id="signupsTable">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Dates selected</th>
            <th># Dates</th>
            <th>Desired nights / mo</th>
          </tr>
        </thead>
        <tbody id="signupsTbody">
        </tbody>
      </table>
    </div>

    <div id="scheduleSection" style="display:none;">
      <h2>Generated Schedule</h2>
      <div id="scheduleCalendar"></div>
    </div>

    <div id="status"></div>
  </div>

 <script>
  // ----- Configuration -----
  const API_BASE = "https://moonlighter-web.fly.dev";  // backend
  const monthInput = document.getElementById("monthInput");
  const refreshBtn = document.getElementById("refreshBtn");
  const runOptimizerBtn = document.getElementById("runOptimizerBtn");
  const viewScheduleBtn = document.getElementById("viewScheduleBtn");
  const downloadCsvBtn = document.getElementById("downloadCsvBtn");
  const providerCountLabel = document.getElementById("providerCountLabel");
  const summaryMonthSpan = document.getElementById("summaryMonth");
  const summaryText = document.getElementById("summaryText");
  const signupsTbody = document.getElementById("signupsTbody");
  const statusEl = document.getElementById("status");
  const scheduleSection = document.getElementById("scheduleSection");
  const scheduleCalendar = document.getElementById("scheduleCalendar");

  function currentMonthString() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  }

  monthInput.value = currentMonthString();
  summaryMonthSpan.textContent = monthInput.value;

  async function loadProvidersCount() {
    try {
      const res = await fetch(`${API_BASE}/api/providers`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const providers = await res.json();
      providerCountLabel.textContent = `${providers.length} providers in system`;
    } catch (err) {
      console.error("Error loading providers:", err);
      providerCountLabel.textContent = "Unable to load providers.";
    }
  }

  async function loadSignups() {
    const month = monthInput.value;
    if (!month) return;
    summaryMonthSpan.textContent = month;
    statusEl.textContent = "Loading signups...";
    signupsTbody.innerHTML = "";
    summaryText.textContent = "Loading...";

    try {
      const url = `${API_BASE}/api/admin/signups?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        summaryText.textContent = "No signups yet for this month.";
        statusEl.textContent = "";
        return;
      }

      // Group by provider_id
      const byProvider = new Map();
      for (const row of data) {
        if (!byProvider.has(row.provider_id)) {
          byProvider.set(row.provider_id, {
            provider_id: row.provider_id,
            provider_name: row.provider_name,
            desired_nights: row.desired_nights,
            dates: [],
          });
        }
        byProvider.get(row.provider_id).dates.push(row.date);
      }

      const providerCount = byProvider.size;
      const totalDates = data.length;
      summaryText.textContent =
        `${providerCount} providers have signed up, covering ${totalDates} provider-nights.`;

      signupsTbody.innerHTML = "";
      const rows = Array.from(byProvider.values()).sort((a, b) =>
        a.provider_name.localeCompare(b.provider_name)
      );

      for (const p of rows) {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        tdName.textContent = p.provider_name;
        tr.appendChild(tdName);
        const tdDates = document.createElement("td");
        tdDates.textContent = p.dates.sort().join(", ");
        tr.appendChild(tdDates);
        const tdCount = document.createElement("td");
        tdCount.textContent = p.dates.length.toString();
        tr.appendChild(tdCount);
        const tdDesired = document.createElement("td");
        tdDesired.textContent = p.desired_nights.toString();
        tr.appendChild(tdDesired);
        signupsTbody.appendChild(tr);
      }

      statusEl.textContent = "Signups loaded.";
    } catch (err) {
      console.error("Error loading signups:", err);
      summaryText.textContent = "Error loading signups.";
      statusEl.textContent = "Error loading signups from backend.";
    }
  }

  async function runOptimizer() {
    const month = monthInput.value;
    if (!month) return;

    statusEl.textContent = "Running optimizer...";
    runOptimizerBtn.disabled = true;

    try {
      const params = new URLSearchParams({ month });
      const url = `${API_BASE}/api/admin/run_optimizer?${params.toString()}`;
      const res = await fetch(url, { method: "POST" });
      const text = await res.text();

      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);

      const data = JSON.parse(text);
      statusEl.textContent = `Optimizer finished for ${data.month}. Assigned ${data.assigned_shifts} shifts. Click 'View schedule' to see results.`;
      
      // Auto-load schedule
      await viewSchedule();
    } catch (err) {
      console.error("Error running optimizer:", err);
      statusEl.textContent = "Error running optimizer (check console).";
    } finally {
      runOptimizerBtn.disabled = false;
    }
  }

  async function viewSchedule() {
    const month = monthInput.value;
    if (!month) return;

    try {
      const url = `${API_BASE}/api/admin/assignments?month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.length === 0) {
        scheduleSection.style.display = "none";
        statusEl.textContent = "No schedule generated yet. Run optimizer first.";
        return;
      }

      // Show schedule
      scheduleSection.style.display = "block";
      
      // Build calendar
      const [year, monthNum] = month.split("-").map(Number);
      const firstDay = new Date(year, monthNum - 1, 1);
      const lastDay = new Date(year, monthNum, 0);
      
      // Group assignments by date
      const assignmentsByDate = {};
      for (const a of data) {
        if (!assignmentsByDate[a.date]) {
          assignmentsByDate[a.date] = [];
        }
        assignmentsByDate[a.date].push(a.provider_name);
      }

      // Build calendar HTML
      let html = '<div class="calendar-grid">';
      
      // Headers
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });

      // Empty cells before first day
      const startDay = firstDay.getDay();
      for (let i = 0; i < startDay; i++) {
        html += '<div class="calendar-day calendar-day-empty"></div>';
      }

      // Days
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const providers = assignmentsByDate[dateStr] || [];
        const hasAssignments = providers.length > 0;
        
        html += `<div class="calendar-day ${hasAssignments ? 'calendar-day-assigned' : ''}">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        if (hasAssignments) {
          html += providers.map(name => `<div>${name}</div>`).join('');
        }
        html += '</div>';
      }

      html += '</div>';
      scheduleCalendar.innerHTML = html;
      statusEl.textContent = `Schedule loaded: ${data.length} assignments.`;

    } catch (err) {
      console.error("Error loading schedule:", err);
      statusEl.textContent = "Error loading schedule.";
    }
  }

  async function downloadCsv() {
    const month = monthInput.value;
    if (!month) return;

    const url = `${API_BASE}/api/admin/signups_csv?month=${encodeURIComponent(month)}`;

    try {
      const res = await fetch(url);
      if (!res.ok) {
        alert(`Error downloading CSV: HTTP ${res.status}`);
        return;
      }

      const text = await res.text();
      const blob = new Blob([text], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `signups_${month}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);

      statusEl.textContent = "CSV downloaded.";
    } catch (err) {
      console.error("Error downloading CSV:", err);
      alert("Network error downloading CSV (see console).");
    }
  }

  refreshBtn.addEventListener("click", loadSignups);
  runOptimizerBtn.addEventListener("click", runOptimizer);
  viewScheduleBtn.addEventListener("click", viewSchedule);
  downloadCsvBtn.addEventListener("click", downloadCsv);

  // Initial load
  loadProvidersCount();
  loadSignups();
</script>
</body>
</html>
