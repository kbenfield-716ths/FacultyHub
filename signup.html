<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#232f3e">
  <title>IRPA Moonlighter Signup</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Top header -->
  <header style="background:#232f3e; color:white; padding:16px 20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <div style="max-width:900px; margin:0 auto; display:flex; align-items:center; gap:16px;">
      <a href="Scheduling.html" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:8px 16px; border-radius:6px; text-decoration:none; font-size:0.9rem; transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚Üê Back</a>
      <h1 style="margin:0; font-size:1.3rem; font-weight:600;">üìÖ Moonlighter Signup</h1>
    </div>
  </header>

  <div id="signupContainer">
    <div id="signupHeader">
      <!-- User display (no dropdown) -->
      <div style="margin-bottom:20px; padding:16px; background:#f0f4f8; border-radius:8px; border-left:4px solid #0052cc;">
        <p style="margin:0; font-size:1.1rem;">
          <strong style="color:#232f3e;">Signing up as:</strong> 
          <span id="providerName" style="color:#0052cc; font-weight:600;">Loading...</span>
        </p>
      </div>

      <div id="monthPickerLabel" style="margin-bottom:20px; font-size:0.95rem;">
        <label style="font-weight:500;">Start month:&nbsp;</label>
        <input type="month" id="monthPicker" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
        &nbsp;&nbsp;
        <label style="font-weight:500;">Show:&nbsp;</label>
        <select id="monthsToShow" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
          <option value="1">1 month</option>
          <option value="2" selected>2 months</option>
          <option value="3">3 months</option>
          <option value="4">4 months</option>
        </select>
      </div>
    </div>

    <!-- Weekday labels (shared for all months) -->
    <div id="weekday-labels"></div>

    <!-- Calendar grid: will contain multiple months stacked vertically -->
    <div id="calendar"></div>

    <!-- Desired nights + Save -->
    <div id="controlsRow">
      <label style="font-weight:500;">
        Desired nights per month:
        <input type="number" id="desired" min="0" max="20" value="4">
      </label>

      <button id="saveBtn">üíæ Save My Signup</button>
    </div>
  </div>

  <!-- Footer -->
  <footer style="text-align:center; padding:24px 8px; font-size:0.85rem; color:#999;">
    UVA Division of Pulmonary and Critical Care
  </footer>

  <script>
    // Use current origin for API calls (works locally and in production)
    const API_BASE = window.location.origin;

    // Helper to get NEXT month "YYYY-MM" (current month + 1)
    function nextMonthString() {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      const y = nextMonth.getFullYear();
      const m = String(nextMonth.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    // Read optional initial provider + month from URL
    const params = new URLSearchParams(window.location.search);
    const paramProviderId = params.get("provider_id") || "";
    const paramProviderName = params.get("provider_name") || "";
    let provider_id = paramProviderId;
    let provider_name = paramProviderName;
    
    // Default to NEXT month unless specified in URL
    let monthStr = params.get("month") || nextMonthString();

    // DOM references
    const providerNameEl = document.getElementById("providerName");
    const monthPickerEl = document.getElementById("monthPicker");
    const monthsToShowEl = document.getElementById("monthsToShow");
    const calendarEl = document.getElementById("calendar");
    const desiredInput = document.getElementById("desired");
    const saveBtn = document.getElementById("saveBtn");

    // Selected dates across ALL visible months (YYYY-MM-DD strings)
    const selectedDates = new Set();

    function updateProviderDisplay() {
      if (provider_name) {
        providerNameEl.textContent = provider_name;
        providerNameEl.style.color = "#0052cc";
      } else {
        providerNameEl.textContent = "Please log in to sign up";
        providerNameEl.style.color = "#d93025";
      }
    }

    function getVisibleMonths() {
      const count = parseInt(monthsToShowEl.value, 10) || 1;
      const [baseYear, baseMonth] = monthStr.split("-").map(Number);
      const months = [];

      for (let i = 0; i < count; i++) {
        const d = new Date(baseYear, baseMonth - 1 + i, 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        months.push(`${y}-${m}`);
      }
      return months;
    }

    function monthKeyFromDateStr(dateStr) {
      return dateStr.slice(0, 7);
    }

    function renderCalendar() {
      calendarEl.innerHTML = "";
      
      // Add weekday headers
      const weekdayLabelsEl = document.getElementById('weekday-labels');
      weekdayLabelsEl.innerHTML = '<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>';

      const visibleMonths = getVisibleMonths();

      for (const mKey of visibleMonths) {
        const [year, month] = mKey.split("-").map(Number);
        const firstDay = new Date(year, month - 1, 1);
        const lastDay  = new Date(year, month, 0);
        const startWeekday = firstDay.getDay();

        // Month label
        const labelCell = document.createElement("div");
        labelCell.className = "month-label";
        labelCell.style.gridColumn = "1 / -1";
        labelCell.style.textAlign = "center";
        labelCell.style.fontWeight = "700";
        labelCell.style.fontSize = "1.1rem";
        labelCell.style.marginTop = "24px";
        labelCell.style.marginBottom = "12px";
        labelCell.style.color = "#232f3e";
        labelCell.textContent = firstDay.toLocaleString("en-US", {
          month: "long",
          year: "numeric"
        });
        calendarEl.appendChild(labelCell);

        // Leading empty cells
        for (let i = 0; i < startWeekday; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "irpa-day-cell empty";
          calendarEl.appendChild(emptyCell);
        }

        // Day cells
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateStr = `${mKey}-${String(day).padStart(2, "0")}`;

          const cell = document.createElement("div");
          cell.className = "irpa-day-cell";
          cell.textContent = day;
          cell.dataset.date = dateStr;

          if (selectedDates.has(dateStr)) {
            cell.classList.add("selected");
          }

          cell.addEventListener("click", () => {
            if (selectedDates.has(dateStr)) {
              selectedDates.delete(dateStr);
              cell.classList.remove("selected");
            } else {
              selectedDates.add(dateStr);
              cell.classList.add("selected");
            }
          });

          calendarEl.appendChild(cell);
        }
      }
    }

    monthPickerEl.addEventListener("change", () => {
      if (!monthPickerEl.value) return;
      monthStr = monthPickerEl.value;
      renderCalendar();
    });

    monthsToShowEl.addEventListener("change", () => {
      renderCalendar();
    });

    saveBtn.addEventListener("click", async () => {
      if (!provider_id || !provider_name) {
        alert("You must be logged in to submit availability. Please log in first.");
        window.location.href = "/";
        return;
      }

      const desiredVal = parseInt(desiredInput.value, 10);
      if (isNaN(desiredVal) || desiredVal < 0) {
        alert("Please enter a valid desired nights number.");
        return;
      }

      const visibleMonths = new Set(getVisibleMonths());
      const monthToDates = new Map();

      for (const dateStr of selectedDates) {
        const mKey = monthKeyFromDateStr(dateStr);
        if (!visibleMonths.has(mKey)) continue;
        if (!monthToDates.has(mKey)) {
          monthToDates.set(mKey, []);
        }
        monthToDates.get(mKey).push(dateStr);
      }

      if (monthToDates.size === 0) {
        alert("No dates selected in the visible months.");
        return;
      }

      try {
        for (const [mKey, dates] of monthToDates.entries()) {
          const payload = {
            provider_id,
            provider_name,
            month: mKey,
            desired_nights: desiredVal,
            dates: dates,
            locked_dates: []
          };

          // CRITICAL FIX: Add credentials for session-based auth
          const res = await fetch(`${API_BASE}/api/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: 'same-origin',  // <-- ADDED THIS
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || res.statusText || "Unknown error");
          }
        }

        alert("‚úÖ Signup saved successfully!");
        console.log("Moonlighting signup successful");
      } catch (err) {
        console.error("Signup error:", err);
        alert(`‚ùå There was a problem saving your signup: ${err.message}`);
      }
    });

    // Load user from session via API call
    async function loadCurrentUser() {
      // Check URL params first
      if (paramProviderId && paramProviderName) {
        provider_id = paramProviderId;
        provider_name = paramProviderName;
        updateProviderDisplay();
        return;
      }

      // Try to fetch current user from session
      try {
        const res = await fetch(`${API_BASE}/api/me`, {
          credentials: 'same-origin'
        });
        
        if (res.ok) {
          const user = await res.json();
          provider_id = user.faculty_id;
          provider_name = user.faculty_name;
          console.log(`Loaded user from session: ${provider_name} (${provider_id})`);
          updateProviderDisplay();
          return;
        }
      } catch (err) {
        console.error("Failed to fetch current user:", err);
      }

      // Fallback to localStorage
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUser.faculty_id) {
        provider_id = currentUser.faculty_id;
        provider_name = currentUser.faculty_name;
        console.log(`Loaded user from localStorage: ${provider_name} (${provider_id})`);
        updateProviderDisplay();
      } else {
        // No user logged in
        providerNameEl.textContent = "Not logged in";
        providerNameEl.style.color = "#d93025";
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Service_Worker.js')
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }

    monthPickerEl.value = monthStr;
    loadCurrentUser();
    renderCalendar();
  </script>
</body>
</html>
