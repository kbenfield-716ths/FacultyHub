<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRPA Moonlighter Signup</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Top header -->
  <header style="text-align:center; padding:12px 8px; font-weight:600;">
    UVA Division of Pulmonary and Critical Care
  </header>

  <div id="signupContainer">
    <div id="signupHeader">
      <div>
        <h1>IRPA Moonlighter Signup</h1>

        <!-- Faculty selector -->
        <div style="margin-bottom: 4px; font-size: 0.9rem;">
          Faculty:&nbsp;
          <select id="providerSelect">
            <option value="">-- select your name --</option>
            <!-- TODO: replace these with your real list -->
            <option value="k_enfield" data-name="Kyle Enfield">Enfield, Kyle</option>
            <option value="a_smith" data-name="Alex Smith">Smith, Alex</option>
            <option value="j_doe" data-name="Jamie Doe">Doe, Jamie</option>
          </select>
        </div>

        <p id="providerInfo"></p>
      </div>

      <div id="monthPickerLabel">
        Start month:&nbsp;
        <input type="month" id="monthPicker">
        &nbsp;Show:&nbsp;
        <select id="monthsToShow">
          <option value="1">1 month</option>
          <option value="2" selected>2 months</option>
          <option value="3">3 months</option>
          <option value="4">4 months</option>
        </select>
      </div>
    </div>

    <!-- Weekday labels (shared for all months) -->
    <div id="weekday-labels">
      <div>Sun</div>
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
    </div>

    <!-- Calendar grid: will contain multiple months stacked vertically -->
    <div id="calendar"></div>

    <!-- Desired nights + Save -->
    <div id="controlsRow">
      <label>
        Desired nights per month (applied to each visible month on save):
        <input type="number" id="desired" min="0" max="20" value="4">
      </label>

      <button id="saveBtn">Save My Signup</button>
    </div>
  </div>

  <!-- Footer -->
  <footer style="text-align:center; padding:16px 8px; font-size:0.85rem; color:#555;">
    built by platypus inc.
  </footer>

  <script>
    // Backend base URL (FastAPI on Fly)
    const API_BASE = "https://moonlighter-web.fly.dev";

    // Helper: current month "YYYY-MM"
    function currentMonthString() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    // URL params
    const params = new URLSearchParams(window.location.search);
    let provider_id = params.get("provider_id") || "";
    let provider_name = params.get("provider_name") || "";
    let monthStr = params.get("month") || currentMonthString();  // base month "YYYY-MM"

    // DOM refs
    const providerSelectEl = document.getElementById("providerSelect");
    const providerInfoEl = document.getElementById("providerInfo");
    const monthPickerEl = document.getElementById("monthPicker");
    const monthsToShowEl = document.getElementById("monthsToShow");
    const calendarEl = document.getElementById("calendar");
    const desiredInput = document.getElementById("desired");
    const saveBtn = document.getElementById("saveBtn");

    // Track selected dates (YYYY-MM-DD)
    const selectedDates = new Set();

    // Try to pre-select faculty from URL params
    function syncProviderFromParams() {
      if (!provider_id && !provider_name) return;

      for (const opt of providerSelectEl.options) {
        if (!opt.value) continue;

        const optId = opt.value;
        const optName = opt.dataset.name;

        if ((provider_id && optId === provider_id) ||
            (provider_name && optName === provider_name)) {
          providerSelectEl.value = optId;
          provider_id = optId;
          provider_name = optName;
          return;
        }
      }
    }

    // When faculty changes via dropdown
    providerSelectEl.addEventListener("change", () => {
      const opt = providerSelectEl.selectedOptions[0];
      if (!opt || !opt.value) {
        provider_id = "";
        provider_name = "";
      } else {
        provider_id = opt.value;
        provider_name = opt.dataset.name || opt.textContent.trim();
      }
      updateHeader();
    });

    function updateHeader() {
      const who = provider_name ? provider_name : "— no faculty selected —";
      providerInfoEl.textContent =
        `Signing up as ${who}. Start month: ${monthStr}. Showing ${monthsToShowEl.value} month(s).`;
      monthPickerEl.value = monthStr;
    }

    function getVisibleMonths() {
      const count = parseInt(monthsToShowEl.value, 10) || 1;
      const [baseYear, baseMonth] = monthStr.split("-").map(Number);
      const months = [];

      for (let i = 0; i < count; i++) {
        const d = new Date(baseYear, baseMonth - 1 + i, 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        months.push(`${y}-${m}`);
      }
      return months;
    }

    function monthKeyFromDateStr(dateStr) {
      // "YYYY-MM-DD" -> "YYYY-MM"
      return dateStr.slice(0, 7);
    }

    // Render calendars for all visible months
    function renderCalendar() {
      calendarEl.innerHTML = "";

      const visibleMonths = getVisibleMonths();

      for (const mKey of visibleMonths) {
        const [year, month] = mKey.split("-").map(Number);
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const startWeekday = firstDay.getDay();

        // Month label row
        const labelCell = document.createElement("div");
        labelCell.className = "month-label";
        labelCell.style.gridColumn = "1 / -1";
        labelCell.style.textAlign = "center";
        labelCell.style.fontWeight = "600";
        labelCell.style.marginTop = "8px";
        labelCell.textContent = firstDay.toLocaleString("en-US", {
          month: "long",
          year: "numeric"
        });
        calendarEl.appendChild(labelCell);

        // Leading blanks
        for (let i = 0; i < startWeekday; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "irpa-day-cell empty";
          calendarEl.appendChild(emptyCell);
        }

        // Days
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateStr = `${mKey}-${String(day).padStart(2, "0")}`;

          const cell = document.createElement("div");
          cell.className = "irpa-day-cell";
          cell.textContent = day;
          cell.dataset.date = dateStr;

          if (selectedDates.has(dateStr)) {
            cell.classList.add("selected");
          }

          cell.addEventListener("click", () => {
            if (selectedDates.has(dateStr)) {
              selectedDates.delete(dateStr);
              cell.classList.remove("selected");
            } else {
              selectedDates.add(dateStr);
              cell.classList.add("selected");
            }
          });

          calendarEl.appendChild(cell);
        }
      }
    }

    // Start month changed
    monthPickerEl.addEventListener("change", () => {
      if (!monthPickerEl.value) return;
      monthStr = monthPickerEl.value;
      updateHeader();
      renderCalendar();
    });

    // Months to show changed
    monthsToShowEl.addEventListener("change", () => {
      updateHeader();
      renderCalendar();
    });

    // Save handler: send one payload per visible month with selections
    saveBtn.addEventListener("click", async () => {
      if (!provider_id || !provider_name) {
        alert("Please select your name from the faculty list before saving.");
        return;
      }

      const desiredVal = parseInt(desiredInput.value, 10);
      if (isNaN(desiredVal) || desiredVal < 0) {
        alert("Please enter a valid desired nights number.");
        return;
      }

      const visibleMonths = new Set(getVisibleMonths());
      const monthToDates = new Map();

      // Group selected dates by visible month
      for (const dateStr of selectedDates) {
        const mKey = monthKeyFromDateStr(dateStr);
        if (!visibleMonths.has(mKey)) continue;
        if (!monthToDates.has(mKey)) {
          monthToDates.set(mKey, []);
        }
        monthToDates.get(mKey).push(dateStr);
      }

      if (monthToDates.size === 0) {
        alert("No dates selected in the visible months.");
        return;
      }

      try {
        for (const [mKey, dates] of monthToDates.entries()) {
          const payload = {
            provider_id,
            provider_name,
            month: mKey,
            desired_nights: desiredVal,
            dates: dates,
            locked_dates: []
          };

          const res = await fetch(`${API_BASE}/api/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            let msg = res.statusText;
            try {
              const err = await res.json();
              if (err && err.detail) msg = err.detail;
            } catch (_) {}
            alert(`Error saving for ${mKey}: ${msg}`);
            return;
          }
        }

        alert("Signup saved successfully for all selected months!");
      } catch (err) {
        console.error(err);
        alert("Network error talking to signup service.");
      }
    });

    // Initial setup
    syncProviderFromParams();
    monthPickerEl.value = monthStr;
    updateHeader();
    renderCalendar();
  </script>
</body>
</html>
