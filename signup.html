<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#232f3e">
  <title>IRPA Moonlighter Signup</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Top header -->
  <header style="background:#232f3e; color:white; padding:16px 20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <div style="max-width:900px; margin:0 auto; display:flex; align-items:center; gap:16px;">
      <a href="Scheduling.html" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:8px 16px; border-radius:6px; text-decoration:none; font-size:0.9rem; transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚Üê Back</a>
      <h1 style="margin:0; font-size:1.3rem; font-weight:600;">üìÖ Moonlighter Signup</h1>
    </div>
  </header>

  <div id="signupContainer">
    <div id="signupHeader">
      <div>
        <p id="providerInfo" style="margin:16px 0 8px 0;"></p>
      </div>

      <!-- Provider selection row -->
      <div id="providerRow" style="margin-bottom:16px;">
        <label for="providerSelect" style="font-weight:500;">Provider:&nbsp;</label>
        <select id="providerSelect" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:1rem;">
          <option value="">Select your name‚Ä¶</option>
        </select>
      </div>

      <div id="monthPickerLabel" style="margin-bottom:20px; font-size:0.95rem;">
        <label style="font-weight:500;">Start month:&nbsp;</label>
        <input type="month" id="monthPicker" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
        &nbsp;&nbsp;
        <label style="font-weight:500;">Show:&nbsp;</label>
        <select id="monthsToShow" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
          <option value="1">1 month</option>
          <option value="2" selected>2 months</option>
          <option value="3">3 months</option>
          <option value="4">4 months</option>
        </select>
      </div>
    </div>

    <!-- Weekday labels (shared for all months) -->
    <div id="weekday-labels"></div>

    <!-- Calendar grid: will contain multiple months stacked vertically -->
    <div id="calendar"></div>

    <!-- Desired nights + Save -->
    <div id="controlsRow">
      <label style="font-weight:500;">
        Desired nights per month:
        <input type="number" id="desired" min="0" max="20" value="4">
      </label>

      <button id="saveBtn">üíæ Save My Signup</button>
    </div>
  </div>

  <!-- Footer -->
  <footer style="text-align:center; padding:24px 8px; font-size:0.85rem; color:#999;">
    UVA Division of Pulmonary and Critical Care
  </footer>

  <script>
    // Backend base URL
    const API_BASE = "https://moonlighter-web.fly.dev";

    // Helper to get current month "YYYY-MM"
    function currentMonthString() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    // Read optional initial provider + month from URL
    const params = new URLSearchParams(window.location.search);
    const paramProviderId = params.get("provider_id") || "";
    const paramProviderName = params.get("provider_name") || "";
    let provider_id = paramProviderId;
    let provider_name = paramProviderName;
    let monthStr = params.get("month") || currentMonthString();

    // DOM references
    const providerInfoEl  = document.getElementById("providerInfo");
    const providerSelectEl = document.getElementById("providerSelect");
    const monthPickerEl   = document.getElementById("monthPicker");
    const monthsToShowEl  = document.getElementById("monthsToShow");
    const calendarEl      = document.getElementById("calendar");
    const desiredInput    = document.getElementById("desired");
    const saveBtn         = document.getElementById("saveBtn");

    // Selected dates across ALL visible months (YYYY-MM-DD strings)
    const selectedDates = new Set();

    function updateHeader() {
      const providerText = provider_name
        ? `Signing up as ${provider_name}`
        : `Select your name to begin`;

      providerInfoEl.innerHTML = `<strong>${providerText}</strong> ‚Ä¢ Start: ${monthStr} ‚Ä¢ Showing ${monthsToShowEl.value} month(s)`;

      monthPickerEl.value = monthStr;
    }

    function getVisibleMonths() {
      const count = parseInt(monthsToShowEl.value, 10) || 1;
      const [baseYear, baseMonth] = monthStr.split("-").map(Number);
      const months = [];

      for (let i = 0; i < count; i++) {
        const d = new Date(baseYear, baseMonth - 1 + i, 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        months.push(`${y}-${m}`);
      }
      return months;
    }

    function monthKeyFromDateStr(dateStr) {
      return dateStr.slice(0, 7);
    }

    function renderCalendar() {
      calendarEl.innerHTML = "";
      
      // Add weekday headers
      const weekdayLabelsEl = document.getElementById('weekday-labels');
      weekdayLabelsEl.innerHTML = '<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>';

      const visibleMonths = getVisibleMonths();

      for (const mKey of visibleMonths) {
        const [year, month] = mKey.split("-").map(Number);
        const firstDay = new Date(year, month - 1, 1);
        const lastDay  = new Date(year, month, 0);
        const startWeekday = firstDay.getDay();

        // Month label
        const labelCell = document.createElement("div");
        labelCell.className = "month-label";
        labelCell.style.gridColumn = "1 / -1";
        labelCell.style.textAlign = "center";
        labelCell.style.fontWeight = "700";
        labelCell.style.fontSize = "1.1rem";
        labelCell.style.marginTop = "24px";
        labelCell.style.marginBottom = "12px";
        labelCell.style.color = "#232f3e";
        labelCell.textContent = firstDay.toLocaleString("en-US", {
          month: "long",
          year: "numeric"
        });
        calendarEl.appendChild(labelCell);

        // Leading empty cells
        for (let i = 0; i < startWeekday; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "irpa-day-cell empty";
          calendarEl.appendChild(emptyCell);
        }

        // Day cells
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateStr = `${mKey}-${String(day).padStart(2, "0")}`;

          const cell = document.createElement("div");
          cell.className = "irpa-day-cell";
          cell.textContent = day;
          cell.dataset.date = dateStr;

          if (selectedDates.has(dateStr)) {
            cell.classList.add("selected");
          }

          cell.addEventListener("click", () => {
            if (selectedDates.has(dateStr)) {
              selectedDates.delete(dateStr);
              cell.classList.remove("selected");
            } else {
              selectedDates.add(dateStr);
              cell.classList.add("selected");
            }
          });

          calendarEl.appendChild(cell);
        }
      }
    }

    monthPickerEl.addEventListener("change", () => {
      if (!monthPickerEl.value) return;
      monthStr = monthPickerEl.value;
      updateHeader();
      renderCalendar();
    });

    monthsToShowEl.addEventListener("change", () => {
      updateHeader();
      renderCalendar();
    });

    providerSelectEl.addEventListener("change", () => {
      const id = providerSelectEl.value;
      const name = providerSelectEl.options[providerSelectEl.selectedIndex]?.text || "";
      provider_id = id;
      provider_name = name;
      updateHeader();
    });

    saveBtn.addEventListener("click", async () => {
      if (!provider_id || !provider_name) {
        alert("Please select your name before saving.");
        return;
      }

      const desiredVal = parseInt(desiredInput.value, 10);
      if (isNaN(desiredVal) || desiredVal < 0) {
        alert("Please enter a valid desired nights number.");
        return;
      }

      const visibleMonths = new Set(getVisibleMonths());
      const monthToDates = new Map();

      for (const dateStr of selectedDates) {
        const mKey = monthKeyFromDateStr(dateStr);
        if (!visibleMonths.has(mKey)) continue;
        if (!monthToDates.has(mKey)) {
          monthToDates.set(mKey, []);
        }
        monthToDates.get(mKey).push(dateStr);
      }

      if (monthToDates.size === 0) {
        alert("No dates selected in the visible months.");
        return;
      }

      try {
        for (const [mKey, dates] of monthToDates.entries()) {
          const payload = {
            provider_id,
            provider_name,
            month: mKey,
            desired_nights: desiredVal,
            dates: dates,
            locked_dates: []
          };

          const res = await fetch(`${API_BASE}/api/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || res.statusText || "Unknown error");
          }
        }

        alert("‚úÖ Signup saved successfully!");
      } catch (err) {
        console.error(err);
        alert("‚ùå There was a problem saving your signup.");
      }
    });

    async function loadProviders() {
      try {
        const res = await fetch(`${API_BASE}/api/providers`);
        if (!res.ok) {
          console.error("Failed to load providers", res.status);
          return;
        }
        const providers = await res.json();

        providers.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          providerSelectEl.appendChild(opt);
        });

        if (paramProviderId) {
          providerSelectEl.value = paramProviderId;
        }

        if (providerSelectEl.value) {
          const selected = providers.find(p => p.id === providerSelectEl.value);
          if (selected) {
            provider_id = selected.id;
            provider_name = selected.name;
          }
        }

        updateHeader();
      } catch (err) {
        console.error("Error loading providers", err);
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Service_Worker.js')
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }

    monthPickerEl.value = monthStr;
    updateHeader();
    renderCalendar();
    loadProviders();
  </script>
  <!-- Load cache manager -->
<script src="/cache-manager.js"></script>

<script>
// Initialize API with caching
const API_URL = window.location.origin;
const api = new CachedAPI(API_URL);

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker.register('/service-worker.js');
      console.log('‚úÖ Service Worker registered:', registration.scope);
      
      // Check for updates every hour
      setInterval(() => {
        registration.update();
      }, 60 * 60 * 1000);
    } catch (error) {
      console.error('‚ùå Service Worker registration failed:', error);
    }
  });
}

// Offline detection
window.addEventListener('online', () => {
  console.log('‚úÖ Back online');
});

window.addEventListener('offline', () => {
  console.log('‚ö†Ô∏è Offline mode');
});
</script>
</body>
</html>
